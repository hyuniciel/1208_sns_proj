# 팔로우 기능 상세 개발 계획

## 개요

Instagram 스타일의 팔로우 기능을 구현합니다. 사용자가 다른 사용자를 팔로우/언팔로우할 수 있는 기능입니다.

**참고 문서:**
- `docs/PRD.md` - 섹션 7.6: 팔로우 기능 요구사항
- `supabase/migrations/db.sql` - follows 테이블 스키마
- 기존 컴포넌트: `ProfileHeader.tsx`, `LikeButton.tsx` (참고용)

---

## 1. API Route 생성

### 1-1. `app/api/follows/route.ts` 생성

**목적:** 팔로우 추가/제거 API

**구현 내용:**

#### POST: 팔로우 추가

**요청 본문:**
```typescript
{
  following_id: string; // 팔로우할 사용자 UUID
}
```

**응답:**
```typescript
{
  success: true,
  follow: {
    id: string;
    follower_id: string;
    following_id: string;
    created_at: string;
  }
}
```

**구현 로직:**
1. 인증 확인 (Clerk)
2. 현재 사용자 UUID 조회
3. `following_id` 검증 (존재하는 사용자인지)
4. 자기 자신 팔로우 방지 (`follower_id !== following_id`)
5. 중복 팔로우 방지 (UNIQUE 제약 확인)
6. `follows` 테이블에 INSERT
7. 성공 응답 반환

**에러 처리:**
- 401: 인증되지 않음
- 400: 잘못된 요청 (자기 자신 팔로우, 중복 팔로우)
- 404: 팔로우할 사용자를 찾을 수 없음
- 500: 서버 에러

#### DELETE: 팔로우 제거

**요청 본문:**
```typescript
{
  following_id: string; // 언팔로우할 사용자 UUID
}
```

**응답:**
```typescript
{
  success: true,
  message: "Unfollowed successfully"
}
```

**구현 로직:**
1. 인증 확인 (Clerk)
2. 현재 사용자 UUID 조회
3. 팔로우 관계 존재 확인
4. 본인의 팔로우만 삭제 가능 (권한 검증)
5. `follows` 테이블에서 DELETE
6. 성공 응답 반환

**에러 처리:**
- 401: 인증되지 않음
- 404: 팔로우 관계를 찾을 수 없음
- 403: 권한 없음 (다른 사람의 팔로우 삭제 시도)
- 500: 서버 에러

---

## 2. FollowButton 컴포넌트 생성

### 2-1. 기본 구조

**파일:** `components/profile/FollowButton.tsx`

**Props 인터페이스:**
```typescript
interface FollowButtonProps {
  targetUserId: string; // 팔로우할 대상 사용자 ID
  initialIsFollowing: boolean; // 초기 팔로우 상태
  initialFollowersCount: number; // 초기 팔로워 수
  onFollowChange?: (isFollowing: boolean, newFollowersCount: number) => void;
  disabled?: boolean; // 버튼 비활성화 (본인 프로필 등)
  size?: "sm" | "md" | "lg"; // 버튼 크기
}
```

**상태 관리:**
- `isFollowing`: 팔로우 상태 (로컬 상태)
- `followersCount`: 팔로워 수 (로컬 상태)
- `isLoading`: 로딩 상태
- `isHovering`: Hover 상태 (언팔로우 표시용)

---

### 2-2. 버튼 스타일

**미팔로우 상태 ("팔로우"):**
- 배경색: 파란색 (`bg-instagram-blue` 또는 `bg-primary`)
- 텍스트: 흰색
- Hover: 약간 어두워짐

**팔로우 중 상태 ("팔로잉"):**
- 배경색: 회색 (`bg-gray-200` 또는 `bg-secondary`)
- 텍스트: 검정색
- Hover: 빨간 테두리 + "언팔로우" 텍스트

**구현 예시:**
```tsx
<Button
  variant={isFollowing ? "outline" : "default"}
  size={size}
  onClick={handleToggleFollow}
  disabled={disabled || isLoading}
  onMouseEnter={() => setIsHovering(true)}
  onMouseLeave={() => setIsHovering(false)}
  className={cn(
    isFollowing && isHovering && "border-red-500 text-red-500 hover:bg-red-50"
  )}
>
  {isLoading
    ? "처리 중..."
    : isFollowing
    ? isHovering
      ? "언팔로우"
      : "팔로잉"
    : "팔로우"}
</Button>
```

---

### 2-3. 팔로우/언팔로우 로직

**구현:**
```typescript
const handleToggleFollow = async () => {
  if (isLoading || disabled) return;

  setIsLoading(true);
  const previousState = isFollowing;
  const previousCount = followersCount;

  try {
    if (isFollowing) {
      // 언팔로우
      const response = await fetch("/api/follows", {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          following_id: targetUserId,
        }),
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || "언팔로우에 실패했습니다.");
      }

      setIsFollowing(false);
      setFollowersCount(Math.max(0, followersCount - 1));
    } else {
      // 팔로우
      const response = await fetch("/api/follows", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          following_id: targetUserId,
        }),
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || "팔로우에 실패했습니다.");
      }

      setIsFollowing(true);
      setFollowersCount(followersCount + 1);
    }

    // 성공 콜백 호출
    if (onFollowChange) {
      onFollowChange(!previousState, isFollowing ? followersCount - 1 : followersCount + 1);
    }
  } catch (error) {
    // 상태 롤백
    setIsFollowing(previousState);
    setFollowersCount(previousCount);
    
    console.error("❌ 팔로우 에러:", error);
    alert(error instanceof Error ? error.message : "알 수 없는 오류가 발생했습니다.");
  } finally {
    setIsLoading(false);
  }
};
```

---

### 2-4. Optimistic UI 업데이트

**구현:**
- API 호출 전에 UI 즉시 업데이트
- 실패 시 상태 롤백
- 사용자 경험 개선

---

## 3. ProfileHeader에 FollowButton 통합

### 3-1. ProfileHeader 수정

**파일:** `components/profile/ProfileHeader.tsx`

**변경 사항:**
1. `FollowButton` 컴포넌트 import
2. 기존 팔로우 버튼 로직 제거
3. `FollowButton` 컴포넌트로 교체
4. `onFollowChange` 콜백으로 팔로워 수 업데이트

**코드 예시:**
```tsx
import FollowButton from "./FollowButton";

// 기존 handleFollow 함수 제거

// 버튼 영역 수정
{user.is_own_profile ? (
  <Button variant="outline" size="sm" className="text-sm" disabled>
    프로필 편집
  </Button>
) : (
  <FollowButton
    targetUserId={user.id}
    initialIsFollowing={user.is_following || false}
    initialFollowersCount={user.followers_count}
    onFollowChange={(isFollowing, newCount) => {
      // 로컬 상태 업데이트 (선택적)
      setFollowersCount(newCount);
      // 부모 컴포넌트에 알림
      if (onFollowChange) {
        onFollowChange(isFollowing, newCount);
      }
    }}
    size="sm"
  />
)}
```

---

## 4. 통계 실시간 업데이트

### 4-1. ProfileHeader에서 팔로워 수 업데이트

**구현:**
- `FollowButton`의 `onFollowChange` 콜백 활용
- 로컬 상태 업데이트
- 부모 컴포넌트에 알림 (필요 시)

### 4-2. 프로필 페이지에서 통계 업데이트

**구현:**
- `ProfileHeader`의 `onFollowChange` 콜백 활용
- 페이지 전체 통계 업데이트 (선택적)
- 서버 재조회 없이 클라이언트 상태만 업데이트

---

## 5. 에러 처리 및 사용자 피드백

### 5-1. 에러 메시지

**구현:**
- 네트워크 에러: "네트워크 오류가 발생했습니다. 다시 시도해주세요."
- 중복 팔로우: "이미 팔로우 중인 사용자입니다."
- 자기 자신 팔로우: "자기 자신을 팔로우할 수 없습니다."
- 권한 에러: "권한이 없습니다."

### 5-2. 로딩 상태

**구현:**
- 버튼 비활성화 (`disabled={isLoading}`)
- "처리 중..." 텍스트 표시
- 클릭 방지

---

## 6. 성능 최적화

### 6-1. Optimistic UI

**구현:**
- API 호출 전 UI 즉시 업데이트
- 실패 시 상태 롤백
- 사용자 경험 개선

### 6-2. 중복 요청 방지

**구현:**
- `isLoading` 상태로 중복 클릭 방지
- 요청 중일 때 버튼 비활성화

---

## 7. 구현 순서

1. **API Route 생성**
   - `app/api/follows/route.ts` 생성
   - POST 핸들러 구현
   - DELETE 핸들러 구현
   - 에러 처리
   - 테스트

2. **FollowButton 컴포넌트 생성**
   - 기본 구조 생성
   - Props 인터페이스 정의
   - 상태 관리
   - 팔로우/언팔로우 로직 구현
   - 버튼 스타일링
   - Hover 효과 구현

3. **ProfileHeader 통합**
   - `FollowButton` import
   - 기존 버튼 로직 제거
   - `FollowButton`으로 교체
   - 콜백 연결

4. **통계 업데이트**
   - 팔로워 수 실시간 업데이트
   - 프로필 페이지 통계 동기화

5. **에러 처리 개선**
   - 사용자 친화적 에러 메시지
   - 상태 롤백 로직

6. **테스트**
   - 팔로우 기능 테스트
   - 언팔로우 기능 테스트
   - 에러 케이스 테스트
   - 중복 팔로우 방지 테스트
   - 자기 자신 팔로우 방지 테스트

---

## 8. 주의사항

1. **자기 자신 팔로우 방지**
   - 클라이언트와 서버 양쪽에서 검증
   - DB 제약 조건 활용 (`CHECK (follower_id != following_id)`)

2. **중복 팔로우 방지**
   - DB UNIQUE 제약 활용 (`UNIQUE(follower_id, following_id)`)
   - 클라이언트에서도 상태 확인

3. **권한 검증**
   - 본인의 팔로우만 삭제 가능
   - 서버에서 엄격히 검증

4. **통계 동기화**
   - `user_stats` 뷰는 자동으로 업데이트됨
   - 클라이언트 상태만 업데이트하면 됨

5. **Optimistic UI**
   - 실패 시 반드시 상태 롤백
   - 사용자에게 명확한 피드백 제공

---

## 9. 참고 파일

- `components/post/LikeButton.tsx` - 좋아요 버튼 구조 참고
- `components/profile/ProfileHeader.tsx` - 통합 대상
- `app/api/likes/route.ts` - API 구조 참고
- `supabase/migrations/db.sql` - follows 테이블 스키마

---

## 10. 완료 체크리스트

- [ ] `app/api/follows/route.ts` 생성 및 구현
  - [ ] POST: 팔로우 추가
  - [ ] DELETE: 팔로우 제거
  - [ ] 인증 검증 (Clerk)
  - [ ] 자기 자신 팔로우 방지
  - [ ] 중복 팔로우 방지
  - [ ] 에러 처리
- [ ] `components/profile/FollowButton.tsx` 생성 및 구현
  - [ ] Props 인터페이스 정의
  - [ ] 상태 관리
  - [ ] "팔로우" 버튼 스타일 (파란색)
  - [ ] "팔로잉" 버튼 스타일 (회색)
  - [ ] Hover 시 "언팔로우" (빨간 테두리)
  - [ ] 팔로우/언팔로우 로직
  - [ ] Optimistic UI 업데이트
  - [ ] 에러 처리 및 상태 롤백
- [ ] ProfileHeader에 FollowButton 통합
  - [ ] FollowButton import
  - [ ] 기존 버튼 로직 제거
  - [ ] FollowButton으로 교체
  - [ ] 콜백 연결
- [ ] 통계 실시간 업데이트
  - [ ] 팔로워 수 업데이트
  - [ ] 프로필 페이지 통계 동기화
- [ ] 에러 처리 개선
  - [ ] 사용자 친화적 에러 메시지
  - [ ] 상태 롤백 로직
- [ ] 테스트
  - [ ] 팔로우 기능 테스트
  - [ ] 언팔로우 기능 테스트
  - [ ] 에러 케이스 테스트
  - [ ] 중복 팔로우 방지 테스트
  - [ ] 자기 자신 팔로우 방지 테스트

