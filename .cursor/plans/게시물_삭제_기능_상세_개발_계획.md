# 게시물 삭제 기능 상세 개발 계획

## 개요

Instagram 스타일의 게시물 삭제 기능을 구현합니다. 본인 게시물만 삭제할 수 있으며, 삭제 시 Supabase Storage의 이미지도 함께 삭제됩니다.

**참고 문서:**
- `docs/PRD.md` - 섹션 7.2: 게시물 삭제 요구사항
- `supabase/migrations/db.sql` - posts 테이블 스키마 및 CASCADE 삭제
- 기존 컴포넌트: `PostCard.tsx`, `PostModal.tsx`

---

## 1. API Route 수정

### 1-1. `app/api/posts/[postId]/route.ts`에 DELETE 핸들러 추가

**목적:** 게시물 삭제 API 구현

**구현 내용:**

#### DELETE: 게시물 삭제

**경로 파라미터:**
- `postId`: 게시물 ID (UUID)

**응답:**
```typescript
{
  success: true,
  message: "Post deleted successfully"
}
```

**구현 로직:**
1. 인증 확인 (Clerk)
2. 현재 사용자 UUID 조회
3. 게시물 존재 확인
4. 소유권 검증 (본인 게시물만 삭제 가능)
5. Supabase Storage에서 이미지 삭제
   - `image_url`에서 파일 경로 추출
   - Storage 버킷에서 파일 삭제
6. DB에서 게시물 삭제 (CASCADE로 좋아요/댓글 자동 삭제)
7. 성공 응답 반환

**에러 처리:**
- 401: 인증되지 않음
- 404: 게시물을 찾을 수 없음
- 403: 권한 없음 (본인 게시물만 삭제 가능)
- 500: 서버 에러 (Storage 삭제 실패 포함)

**주의사항:**
- Storage 파일 삭제 실패 시에도 DB 삭제는 진행 (선택적)
- 또는 트랜잭션처럼 처리 (DB 삭제 실패 시 Storage 삭제 롤백 불가)

---

## 2. DropdownMenu 컴포넌트 확인/설치

### 2-1. shadcn/ui DropdownMenu 확인

**확인 사항:**
- `components/ui/dropdown-menu.tsx` 파일 존재 여부
- 없으면 설치 필요: `pnpx shadcn@latest add dropdown-menu`

**사용할 컴포넌트:**
- `DropdownMenu`
- `DropdownMenuTrigger`
- `DropdownMenuContent`
- `DropdownMenuItem`
- `DropdownMenuSeparator` (선택적)

---

## 3. PostCard에 DropdownMenu 통합

### 3-1. PostCard 수정

**파일:** `components/post/PostCard.tsx`

**변경 사항:**
1. `DropdownMenu` 컴포넌트 import
2. `MoreHorizontal` 버튼을 `DropdownMenuTrigger`로 변경
3. 삭제 메뉴 아이템 추가
4. 삭제 핸들러 구현

**구현 예시:**
```tsx
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";

// 헤더 부분
{currentUserId === post.user_id && (
  <DropdownMenu>
    <DropdownMenuTrigger asChild>
      <Button variant="ghost" size="sm" className="p-0">
        <MoreHorizontal className="w-5 h-5 text-text-primary" />
      </Button>
    </DropdownMenuTrigger>
    <DropdownMenuContent align="end">
      <DropdownMenuItem
        className="text-red-500 focus:text-red-500 focus:bg-red-50"
        onClick={handleDeleteClick}
      >
        삭제
      </DropdownMenuItem>
    </DropdownMenuContent>
  </DropdownMenu>
)}
```

---

## 4. 삭제 확인 다이얼로그

### 4-1. AlertDialog 컴포넌트 확인/설치

**확인 사항:**
- `components/ui/alert-dialog.tsx` 파일 존재 여부
- 없으면 설치 필요: `pnpx shadcn@latest add alert-dialog`

**사용할 컴포넌트:**
- `AlertDialog`
- `AlertDialogTrigger` (선택적, 버튼에서 직접 열기)
- `AlertDialogContent`
- `AlertDialogHeader`
- `AlertDialogTitle`
- `AlertDialogDescription`
- `AlertDialogFooter`
- `AlertDialogAction`
- `AlertDialogCancel`

### 4-2. PostCard에 삭제 확인 다이얼로그 통합

**구현:**
```tsx
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";

const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);
const [isDeleting, setIsDeleting] = useState(false);

const handleDeleteClick = () => {
  setIsDeleteDialogOpen(true);
};

const handleDeleteConfirm = async () => {
  setIsDeleting(true);
  try {
    const response = await fetch(`/api/posts/${post.id}`, {
      method: "DELETE",
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.error || "게시물 삭제에 실패했습니다.");
    }

    // 삭제 성공 시 부모 컴포넌트에 알림
    if (onDelete) {
      onDelete(post.id);
    }

    setIsDeleteDialogOpen(false);
  } catch (error) {
    console.error("❌ 게시물 삭제 에러:", error);
    alert(
      error instanceof Error
        ? error.message
        : "게시물 삭제에 실패했습니다."
    );
  } finally {
    setIsDeleting(false);
  }
};

// 렌더링
<AlertDialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>
  <AlertDialogContent>
    <AlertDialogHeader>
      <AlertDialogTitle>게시물을 삭제하시겠어요?</AlertDialogTitle>
      <AlertDialogDescription>
        이 작업은 되돌릴 수 없습니다. 게시물이 영구적으로 삭제됩니다.
      </AlertDialogDescription>
    </AlertDialogHeader>
    <AlertDialogFooter>
      <AlertDialogCancel disabled={isDeleting}>취소</AlertDialogCancel>
      <AlertDialogAction
        onClick={handleDeleteConfirm}
        disabled={isDeleting}
        className="bg-red-500 hover:bg-red-600"
      >
        {isDeleting ? "삭제 중..." : "삭제"}
      </AlertDialogAction>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>
```

---

## 5. 삭제 후 피드에서 제거

### 5-1. PostCard Props 수정

**변경 사항:**
- `onDelete` prop 추가 (선택적)

**인터페이스:**
```typescript
interface PostCardProps {
  // ... 기존 props
  onDelete?: (postId: string) => void;
}
```

### 5-2. PostFeed에서 삭제 처리

**파일:** `components/post/PostFeed.tsx`

**구현:**
```tsx
const handlePostDelete = useCallback((postId: string) => {
  setPosts((prevPosts) => prevPosts.filter((post) => post.id !== postId));
}, []);

// PostCard에 전달
<PostCard
  // ... 기존 props
  onDelete={handlePostDelete}
/>
```

### 5-3. PostGrid에서 삭제 처리

**파일:** `components/profile/PostGrid.tsx`

**구현:**
```tsx
const handlePostDelete = useCallback((postId: string) => {
  setPosts((prevPosts) => prevPosts.filter((post) => post.id !== postId));
}, []);

// PostCard는 PostGrid에서 직접 사용하지 않지만,
// PostModal에서 삭제 시 PostGrid도 업데이트 필요
// PostModal에 onDelete prop 전달 (선택적)
```

### 5-4. PostModal에서 삭제 처리

**파일:** `components/post/PostModal.tsx`

**구현:**
- `onPostDelete` prop 추가 (선택적)
- 삭제 성공 시 모달 닫기
- 부모 컴포넌트에 삭제 알림

---

## 6. Storage 이미지 삭제 로직

### 6-1. 이미지 URL에서 파일 경로 추출

**구현:**
```typescript
// image_url 예시: https://[project].supabase.co/storage/v1/object/public/posts/user123/1234567890-abc123.jpg
// 또는: https://[project].supabase.co/storage/v1/object/public/posts/user123/1234567890-abc123.jpg?t=...

function extractFilePath(imageUrl: string, bucketName: string = "posts"): string | null {
  try {
    const url = new URL(imageUrl);
    const pathMatch = url.pathname.match(new RegExp(`/${bucketName}/(.+)$`));
    if (pathMatch && pathMatch[1]) {
      return pathMatch[1];
    }
    return null;
  } catch {
    return null;
  }
}
```

### 6-2. Storage에서 파일 삭제

**구현:**
```typescript
const filePath = extractFilePath(post.image_url, "posts");

if (filePath) {
  const { error: storageError } = await supabase.storage
    .from("posts")
    .remove([filePath]);

  if (storageError) {
    console.error("⚠️ Storage 파일 삭제 실패:", storageError);
    // DB 삭제는 계속 진행 (선택적)
  } else {
    console.log("✅ Storage 파일 삭제 완료:", filePath);
  }
}
```

---

## 7. 에러 처리 및 사용자 피드백

### 7-1. 에러 메시지

**구현:**
- 네트워크 에러: "네트워크 오류가 발생했습니다. 다시 시도해주세요."
- 권한 에러: "본인의 게시물만 삭제할 수 있습니다."
- 삭제 실패: "게시물 삭제에 실패했습니다."

### 7-2. 로딩 상태

**구현:**
- 삭제 중 버튼 비활성화
- "삭제 중..." 텍스트 표시
- 다이얼로그 닫기 방지

---

## 8. 구현 순서

1. **shadcn/ui 컴포넌트 확인/설치**
   - DropdownMenu 확인/설치
   - AlertDialog 확인/설치

2. **API Route 수정**
   - `app/api/posts/[postId]/route.ts`에 DELETE 핸들러 추가
   - Storage 이미지 삭제 로직 구현
   - 소유권 검증
   - 에러 처리
   - 테스트

3. **PostCard에 DropdownMenu 통합**
   - DropdownMenu import
   - MoreHorizontal 버튼을 DropdownMenuTrigger로 변경
   - 삭제 메뉴 아이템 추가

4. **삭제 확인 다이얼로그 구현**
   - AlertDialog 컴포넌트 통합
   - 삭제 핸들러 구현
   - 로딩 상태 관리

5. **PostCard Props 수정**
   - `onDelete` prop 추가
   - 삭제 성공 시 콜백 호출

6. **PostFeed에서 삭제 처리**
   - `handlePostDelete` 구현
   - PostCard에 `onDelete` 전달

7. **PostGrid에서 삭제 처리** (선택적)
   - 삭제 시 그리드에서 제거

8. **PostModal에서 삭제 처리** (선택적)
   - 삭제 시 모달 닫기
   - 부모 컴포넌트에 알림

9. **테스트**
   - 삭제 기능 테스트
   - 권한 검증 테스트
   - Storage 삭제 테스트
   - 에러 케이스 테스트

---

## 9. 주의사항

1. **Storage 파일 경로 추출**
   - 다양한 URL 형식 처리
   - 쿼리 파라미터 제거
   - 경로 추출 실패 시 처리

2. **Storage 삭제 실패 처리**
   - DB 삭제는 계속 진행할지 결정
   - 사용자에게 알림할지 결정

3. **CASCADE 삭제**
   - DB 스키마에 `ON DELETE CASCADE` 설정되어 있음
   - 게시물 삭제 시 좋아요/댓글 자동 삭제
   - Storage 이미지만 별도 삭제 필요

4. **권한 검증**
   - 클라이언트와 서버 양쪽에서 검증
   - 서버에서 엄격히 검증 필수

5. **사용자 경험**
   - 삭제 확인 다이얼로그로 실수 방지
   - 명확한 에러 메시지
   - 로딩 상태 표시

---

## 10. 참고 파일

- `components/post/PostCard.tsx` - DropdownMenu 통합 대상
- `components/post/PostFeed.tsx` - 삭제 후 제거 처리
- `components/post/PostModal.tsx` - 모달에서 삭제 처리 (선택적)
- `components/profile/PostGrid.tsx` - 그리드에서 삭제 처리 (선택적)
- `app/api/posts/[postId]/route.ts` - DELETE 핸들러 추가 대상
- `app/api/posts/route.ts` - POST 핸들러 참고 (Storage 업로드 로직)

---

## 11. 완료 체크리스트

- [ ] shadcn/ui 컴포넌트 확인/설치
  - [ ] DropdownMenu 확인/설치
  - [ ] AlertDialog 확인/설치
- [ ] `app/api/posts/[postId]/route.ts` 수정
  - [ ] DELETE 핸들러 구현
  - [ ] 인증 검증 (Clerk)
  - [ ] 소유권 검증 (본인 게시물만)
  - [ ] Storage 이미지 삭제 로직
  - [ ] DB 게시물 삭제
  - [ ] 에러 처리
- [ ] PostCard에 DropdownMenu 통합
  - [ ] DropdownMenu import
  - [ ] MoreHorizontal 버튼을 DropdownMenuTrigger로 변경
  - [ ] 삭제 메뉴 아이템 추가
- [ ] 삭제 확인 다이얼로그 구현
  - [ ] AlertDialog 컴포넌트 통합
  - [ ] 삭제 핸들러 구현
  - [ ] 로딩 상태 관리
- [ ] PostCard Props 수정
  - [ ] `onDelete` prop 추가
  - [ ] 삭제 성공 시 콜백 호출
- [ ] PostFeed에서 삭제 처리
  - [ ] `handlePostDelete` 구현
  - [ ] PostCard에 `onDelete` 전달
- [ ] PostGrid에서 삭제 처리 (선택적)
  - [ ] 삭제 시 그리드에서 제거
- [ ] PostModal에서 삭제 처리 (선택적)
  - [ ] 삭제 시 모달 닫기
  - [ ] 부모 컴포넌트에 알림
- [ ] 테스트
  - [ ] 삭제 기능 테스트
  - [ ] 권한 검증 테스트
  - [ ] Storage 삭제 테스트
  - [ ] 에러 케이스 테스트

