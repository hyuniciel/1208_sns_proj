# ëŒ“ê¸€ ê¸°ëŠ¥ ìƒì„¸ ê°œë°œ ê³„íš

## ê°œìš”

Instagram ìŠ¤íƒ€ì¼ì˜ ëŒ“ê¸€ ê¸°ëŠ¥ì„ êµ¬í˜„í•©ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ê²Œì‹œë¬¼ì— ëŒ“ê¸€ì„ ì‘ì„±í•˜ê³  ì‚­ì œí•  ìˆ˜ ìˆìœ¼ë©°, PostCardì—ì„œëŠ” ìµœì‹  2ê°œë§Œ ë¯¸ë¦¬ë³´ê¸°ë¡œ í‘œì‹œë©ë‹ˆë‹¤.

**ì°¸ê³  ë¬¸ì„œ:**
- [PRD.md](../docs/PRD.md) - ëŒ“ê¸€ ê¸°ëŠ¥ ì •ì˜ (285-291ì¤„, 462-472ì¤„)
- [db.sql](../../supabase/migrations/db.sql) - comments í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ (91-114ì¤„)
- [TODO.md](../docs/TODO.md) - ëŒ“ê¸€ ê¸°ëŠ¥ TODO (120-137ì¤„)

**í˜„ì¬ ìƒíƒœ:**
- âœ… `comments` í…Œì´ë¸” ìƒì„± ì™„ë£Œ (DB ìŠ¤í‚¤ë§ˆ)
- âœ… `post_stats` ë·°ì— `comments_count` í¬í•¨
- âœ… `app/api/posts/route.ts`ì—ì„œ `comments_count` ì¡°íšŒ ì™„ë£Œ
- âœ… `PostCard.tsx`ì— ëŒ“ê¸€ ìˆ˜ í‘œì‹œ UI ì¡´ì¬ (ê¸°ëŠ¥ ë¯¸êµ¬í˜„)
- âŒ `app/api/comments/route.ts` ë¯¸êµ¬í˜„
- âŒ `CommentList.tsx` ì»´í¬ë„ŒíŠ¸ ë¯¸êµ¬í˜„
- âŒ `CommentForm.tsx` ì»´í¬ë„ŒíŠ¸ ë¯¸êµ¬í˜„
- âŒ PostCardì— ëŒ“ê¸€ ê¸°ëŠ¥ í†µí•© ë¯¸êµ¬í˜„

---

## 1. API Route ìƒì„±: ëŒ“ê¸€ ì‘ì„±/ì‚­ì œ/ì¡°íšŒ

### 1.1 `app/api/comments/route.ts` ìƒì„±

**íŒŒì¼ ê²½ë¡œ:** `app/api/comments/route.ts`

**ê¸°ëŠ¥:**
- GET: ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ (ì„ íƒì )
- POST: ëŒ“ê¸€ ì‘ì„±
- DELETE: ëŒ“ê¸€ ì‚­ì œ (ë³¸ì¸ë§Œ)
- ì¸ì¦ ê²€ì¦ (Clerk)
- ì—ëŸ¬ í•¸ë“¤ë§ ë° ë¡œê¹…

**êµ¬í˜„ ì„¸ë¶€ì‚¬í•­:**

#### GET í•¸ë“¤ëŸ¬ (ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ, ì„ íƒì )

1. **ì¸ì¦ í™•ì¸** (ì„ íƒì  - ê³µê°œ ëŒ“ê¸€ì€ ì¸ì¦ ì—†ì´ ì¡°íšŒ ê°€ëŠ¥)
2. **ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì²˜ë¦¬**
   - `post_id`: ê²Œì‹œë¬¼ ID (í•„ìˆ˜)
   - `limit`: ìµœëŒ€ ëŒ“ê¸€ ìˆ˜ (ê¸°ë³¸ê°’: 50)
   - `offset`: ê±´ë„ˆë›¸ ëŒ“ê¸€ ìˆ˜ (ê¸°ë³¸ê°’: 0)
3. **ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ**
   - `comments` í…Œì´ë¸”ì—ì„œ `post_id`ë¡œ í•„í„°ë§
   - `users` í…Œì´ë¸”ê³¼ JOINí•˜ì—¬ ì‚¬ìš©ì ì •ë³´ í¬í•¨
   - `created_at ASC` ì •ë ¬ (ìµœì‹ ìˆœ)
4. **ì‘ë‹µ ë°˜í™˜**
   ```typescript
   {
     comments: CommentWithUser[],
     total: number
   }
   ```

#### POST í•¸ë“¤ëŸ¬ (ëŒ“ê¸€ ì‘ì„±)

1. **ì¸ì¦ í™•ì¸**
   - Clerk `auth()`ë¡œ í˜„ì¬ ì‚¬ìš©ì í™•ì¸
   - ì¸ì¦ë˜ì§€ ì•Šì€ ê²½ìš° 401 ë°˜í™˜

2. **ìš”ì²­ ë³¸ë¬¸ íŒŒì‹±**
   - `post_id`: ëŒ“ê¸€ì„ ì‘ì„±í•  ê²Œì‹œë¬¼ ID (UUID)
   - `content`: ëŒ“ê¸€ ë‚´ìš© (í•„ìˆ˜, ìµœì†Œ 1ì)
   - í•„ìˆ˜ í•„ë“œ ê²€ì¦

3. **ì‚¬ìš©ì ID ì¡°íšŒ**
   - Clerk `userId`ë¡œ Supabase `users` í…Œì´ë¸”ì—ì„œ ì‚¬ìš©ì UUID ì¡°íšŒ
   - ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ 404 ë°˜í™˜

4. **ê²Œì‹œë¬¼ ì¡´ì¬ í™•ì¸**
   - `posts` í…Œì´ë¸”ì—ì„œ `post_id` í™•ì¸
   - ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ 404 ë°˜í™˜

5. **ëŒ“ê¸€ ë‚´ìš© ê²€ì¦**
   - ë¹ˆ ë¬¸ìì—´ ë˜ëŠ” ê³µë°±ë§Œ ìˆëŠ” ê²½ìš° 400 ë°˜í™˜
   - `trim()` í›„ ê¸¸ì´ í™•ì¸ (ìµœì†Œ 1ì)

6. **ëŒ“ê¸€ ì €ì¥**
   - `comments` í…Œì´ë¸”ì— ë ˆì½”ë“œ ì‚½ì…
   - `post_id`, `user_id`, `content` ì €ì¥
   - `created_at`, `updated_at` ìë™ ì„¤ì •

7. **ì‚¬ìš©ì ì •ë³´ í¬í•¨í•˜ì—¬ ì‘ë‹µ ë°˜í™˜**
   ```typescript
   {
     success: true,
     comment: CommentWithUser
   }
   ```

#### DELETE í•¸ë“¤ëŸ¬ (ëŒ“ê¸€ ì‚­ì œ)

1. **ì¸ì¦ í™•ì¸**
   - Clerk `auth()`ë¡œ í˜„ì¬ ì‚¬ìš©ì í™•ì¸
   - ì¸ì¦ë˜ì§€ ì•Šì€ ê²½ìš° 401 ë°˜í™˜

2. **ìš”ì²­ ë³¸ë¬¸ íŒŒì‹±**
   - `comment_id`: ì‚­ì œí•  ëŒ“ê¸€ ID (UUID)
   - í•„ìˆ˜ í•„ë“œ ê²€ì¦

3. **ì‚¬ìš©ì ID ì¡°íšŒ**
   - Clerk `userId`ë¡œ Supabase `users` í…Œì´ë¸”ì—ì„œ ì‚¬ìš©ì UUID ì¡°íšŒ

4. **ëŒ“ê¸€ ì¡´ì¬ ë° ì†Œìœ ê¶Œ í™•ì¸**
   - `comments` í…Œì´ë¸”ì—ì„œ `comment_id` ì¡°íšŒ
   - ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ 404 ë°˜í™˜
   - `user_id`ê°€ í˜„ì¬ ì‚¬ìš©ìì™€ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ 403 ë°˜í™˜

5. **ëŒ“ê¸€ ì‚­ì œ**
   - `comments` í…Œì´ë¸”ì—ì„œ ë ˆì½”ë“œ ì‚­ì œ
   - CASCADEë¡œ ì¸í•´ ìë™ ì²˜ë¦¬ë¨

6. **ì‘ë‹µ ë°˜í™˜**
   ```typescript
   {
     success: true,
     message: "Comment deleted"
   }
   ```

**ì½”ë“œ êµ¬ì¡°:**
```typescript
import { NextRequest, NextResponse } from "next/server";
import { auth } from "@clerk/nextjs/server";
import { createClerkSupabaseClient } from "@/lib/supabase/server";
import type { Comment, CommentWithUser } from "@/lib/types";

/**
 * GET: ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ (ì„ íƒì )
 *
 * ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°:
 * - post_id: ê²Œì‹œë¬¼ ID (í•„ìˆ˜)
 * - limit: ìµœëŒ€ ëŒ“ê¸€ ìˆ˜ (ê¸°ë³¸ê°’: 50)
 * - offset: ê±´ë„ˆë›¸ ëŒ“ê¸€ ìˆ˜ (ê¸°ë³¸ê°’: 0)
 */
export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const postId = searchParams.get("post_id");
    const limit = parseInt(searchParams.get("limit") || "50");
    const offset = parseInt(searchParams.get("offset") || "0");

    if (!postId) {
      return NextResponse.json(
        { error: "post_id is required" },
        { status: 400 }
      );
    }

    const supabase = createClerkSupabaseClient();

    // ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ
    const { data: comments, error: commentsError } = await supabase
      .from("comments")
      .select(`
        id,
        post_id,
        user_id,
        content,
        created_at,
        updated_at,
        users!comments_user_id_fkey (
          id,
          clerk_id,
          name,
          created_at
        )
      `)
      .eq("post_id", postId)
      .order("created_at", { ascending: true })
      .range(offset, offset + limit - 1);

    if (commentsError) {
      return NextResponse.json(
        { error: "Failed to fetch comments", details: commentsError.message },
        { status: 500 }
      );
    }

    // ì´ ëŒ“ê¸€ ìˆ˜ ì¡°íšŒ
    const { count } = await supabase
      .from("comments")
      .select("*", { count: "exact", head: true })
      .eq("post_id", postId);

    return NextResponse.json({
      comments: comments || [],
      total: count || 0,
    });
  } catch (error) {
    console.error("âŒ GET /api/comments ì—ëŸ¬:", error);
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}

/**
 * POST: ëŒ“ê¸€ ì‘ì„±
 *
 * ìš”ì²­ ë³¸ë¬¸:
 * {
 *   post_id: string (UUID),
 *   content: string
 * }
 */
export async function POST(request: NextRequest) {
  try {
    console.group("POST /api/comments");

    // 1. ì¸ì¦ í™•ì¸
    const { userId: clerkUserId } = await auth();
    if (!clerkUserId) {
      console.log("âŒ ì¸ì¦ ì‹¤íŒ¨");
      return NextResponse.json(
        { error: "Unauthorized" },
        { status: 401 }
      );
    }
    console.log("âœ… ì¸ì¦ í™•ì¸:", clerkUserId);

    // 2. ìš”ì²­ ë³¸ë¬¸ íŒŒì‹±
    const body = await request.json();
    const { post_id, content } = body;

    if (!post_id || typeof post_id !== "string") {
      console.log("âŒ ì˜ëª»ëœ ìš”ì²­: post_id í•„ìˆ˜");
      return NextResponse.json(
        { error: "post_id is required" },
        { status: 400 }
      );
    }

    if (!content || typeof content !== "string" || content.trim().length === 0) {
      console.log("âŒ ì˜ëª»ëœ ìš”ì²­: content í•„ìˆ˜");
      return NextResponse.json(
        { error: "content is required and cannot be empty" },
        { status: 400 }
      );
    }

    console.log("ğŸ“‹ ìš”ì²­ ë°ì´í„°:", { post_id, contentLength: content.length });

    // 3. Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„±
    const supabase = createClerkSupabaseClient();

    // 4. í˜„ì¬ ì‚¬ìš©ì UUID ì¡°íšŒ
    const { data: currentUser, error: userError } = await supabase
      .from("users")
      .select("id")
      .eq("clerk_id", clerkUserId)
      .single();

    if (userError || !currentUser) {
      console.error("âŒ ì‚¬ìš©ì ì¡°íšŒ ì‹¤íŒ¨:", userError);
      return NextResponse.json(
        { error: "User not found" },
        { status: 404 }
      );
    }
    console.log("âœ… í˜„ì¬ ì‚¬ìš©ì UUID:", currentUser.id);

    // 5. ê²Œì‹œë¬¼ ì¡´ì¬ í™•ì¸
    const { data: post, error: postError } = await supabase
      .from("posts")
      .select("id")
      .eq("id", post_id)
      .single();

    if (postError || !post) {
      console.error("âŒ ê²Œì‹œë¬¼ ì¡°íšŒ ì‹¤íŒ¨:", postError);
      return NextResponse.json(
        { error: "Post not found" },
        { status: 404 }
      );
    }
    console.log("âœ… ê²Œì‹œë¬¼ í™•ì¸:", post.id);

    // 6. ëŒ“ê¸€ ì €ì¥
    const { data: comment, error: commentError } = await supabase
      .from("comments")
      .insert({
        post_id,
        user_id: currentUser.id,
        content: content.trim(),
      })
      .select()
      .single();

    if (commentError) {
      console.error("âŒ ëŒ“ê¸€ ì €ì¥ ì‹¤íŒ¨:", commentError);
      return NextResponse.json(
        { error: "Failed to create comment", details: commentError.message },
        { status: 500 }
      );
    }

    // 7. ì‚¬ìš©ì ì •ë³´ í¬í•¨í•˜ì—¬ ì‘ë‹µ
    const { data: user } = await supabase
      .from("users")
      .select("id, clerk_id, name, created_at")
      .eq("id", currentUser.id)
      .single();

    const commentWithUser: CommentWithUser = {
      ...comment,
      user: user || {
        id: currentUser.id,
        clerk_id: clerkUserId,
        name: "Unknown",
        created_at: comment.created_at,
      },
    };

    console.log("âœ… ëŒ“ê¸€ ì‘ì„± ì™„ë£Œ:", comment.id);
    console.groupEnd();

    return NextResponse.json({
      success: true,
      comment: commentWithUser,
    });
  } catch (error) {
    console.error("âŒ POST /api/comments ì—ëŸ¬:", error);
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}

/**
 * DELETE: ëŒ“ê¸€ ì‚­ì œ
 *
 * ìš”ì²­ ë³¸ë¬¸:
 * {
 *   comment_id: string (UUID)
 * }
 */
export async function DELETE(request: NextRequest) {
  try {
    console.group("DELETE /api/comments");

    // 1. ì¸ì¦ í™•ì¸
    const { userId: clerkUserId } = await auth();
    if (!clerkUserId) {
      console.log("âŒ ì¸ì¦ ì‹¤íŒ¨");
      return NextResponse.json(
        { error: "Unauthorized" },
        { status: 401 }
      );
    }
    console.log("âœ… ì¸ì¦ í™•ì¸:", clerkUserId);

    // 2. ìš”ì²­ ë³¸ë¬¸ íŒŒì‹±
    const body = await request.json();
    const { comment_id } = body;

    if (!comment_id || typeof comment_id !== "string") {
      console.log("âŒ ì˜ëª»ëœ ìš”ì²­: comment_id í•„ìˆ˜");
      return NextResponse.json(
        { error: "comment_id is required" },
        { status: 400 }
      );
    }
    console.log("ğŸ“‹ ìš”ì²­ ë°ì´í„°:", { comment_id });

    // 3. Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„±
    const supabase = createClerkSupabaseClient();

    // 4. í˜„ì¬ ì‚¬ìš©ì UUID ì¡°íšŒ
    const { data: currentUser, error: userError } = await supabase
      .from("users")
      .select("id")
      .eq("clerk_id", clerkUserId)
      .single();

    if (userError || !currentUser) {
      console.error("âŒ ì‚¬ìš©ì ì¡°íšŒ ì‹¤íŒ¨:", userError);
      return NextResponse.json(
        { error: "User not found" },
        { status: 404 }
      );
    }
    console.log("âœ… í˜„ì¬ ì‚¬ìš©ì UUID:", currentUser.id);

    // 5. ëŒ“ê¸€ ì¡´ì¬ ë° ì†Œìœ ê¶Œ í™•ì¸
    const { data: comment, error: commentError } = await supabase
      .from("comments")
      .select("id, user_id")
      .eq("id", comment_id)
      .single();

    if (commentError || !comment) {
      console.error("âŒ ëŒ“ê¸€ ì¡°íšŒ ì‹¤íŒ¨:", commentError);
      return NextResponse.json(
        { error: "Comment not found" },
        { status: 404 }
      );
    }

    if (comment.user_id !== currentUser.id) {
      console.log("âŒ ê¶Œí•œ ì—†ìŒ: ë³¸ì¸ ëŒ“ê¸€ë§Œ ì‚­ì œ ê°€ëŠ¥");
      return NextResponse.json(
        { error: "Forbidden: You can only delete your own comments" },
        { status: 403 }
      );
    }

    // 6. ëŒ“ê¸€ ì‚­ì œ
    const { error: deleteError } = await supabase
      .from("comments")
      .delete()
      .eq("id", comment_id);

    if (deleteError) {
      console.error("âŒ ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨:", deleteError);
      return NextResponse.json(
        { error: "Failed to delete comment", details: deleteError.message },
        { status: 500 }
      );
    }

    console.log("âœ… ëŒ“ê¸€ ì‚­ì œ ì™„ë£Œ");
    console.groupEnd();

    return NextResponse.json({
      success: true,
      message: "Comment deleted",
    });
  } catch (error) {
    console.error("âŒ DELETE /api/comments ì—ëŸ¬:", error);
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}
```

**í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤:**
1. âœ… ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ì â†’ 401
2. âœ… ì˜ëª»ëœ post_id â†’ 400 ë˜ëŠ” 404
3. âœ… ë¹ˆ ëŒ“ê¸€ ë‚´ìš© â†’ 400
4. âœ… ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²Œì‹œë¬¼ â†’ 404
5. âœ… ì •ìƒ ëŒ“ê¸€ ì‘ì„± â†’ 200
6. âœ… ë³¸ì¸ì´ ì•„ë‹Œ ëŒ“ê¸€ ì‚­ì œ â†’ 403
7. âœ… ì •ìƒ ëŒ“ê¸€ ì‚­ì œ â†’ 200

---

## 2. CommentList ì»´í¬ë„ŒíŠ¸ ìƒì„±

### 2.1 `components/comment/CommentList.tsx` ìƒì„±

**íŒŒì¼ ê²½ë¡œ:** `components/comment/CommentList.tsx`

**ê¸°ëŠ¥:**
- ëŒ“ê¸€ ëª©ë¡ ë Œë”ë§
- PostCard: ìµœì‹  2ê°œë§Œ í‘œì‹œ
- ìƒì„¸ ëª¨ë‹¬: ì „ì²´ ëŒ“ê¸€ + ìŠ¤í¬ë¡¤ (ë‚˜ì¤‘ì— êµ¬í˜„)
- ì‚­ì œ ë²„íŠ¼ (ë³¸ì¸ë§Œ í‘œì‹œ)
- "ëª¨ë‘ ë³´ê¸°" ë§í¬

**Props íƒ€ì…:**
```typescript
interface CommentListProps {
  postId: string;
  comments: CommentWithUser[];
  maxVisible?: number; // ìµœëŒ€ í‘œì‹œ ê°œìˆ˜ (ê¸°ë³¸ê°’: undefined, ì „ì²´ í‘œì‹œ)
  showAllLink?: boolean; // "ëª¨ë‘ ë³´ê¸°" ë§í¬ í‘œì‹œ ì—¬ë¶€
  onCommentDelete?: (commentId: string) => void; // ì‚­ì œ ì½œë°±
  currentUserId?: string; // í˜„ì¬ ì‚¬ìš©ì ID (ì‚­ì œ ë²„íŠ¼ í‘œì‹œìš©)
  onShowAll?: () => void; // "ëª¨ë‘ ë³´ê¸°" í´ë¦­ ì‹œ ì½œë°±
}
```

**êµ¬í˜„ ì„¸ë¶€ì‚¬í•­:**

1. **ëŒ“ê¸€ ë Œë”ë§**
   - `comments` ë°°ì—´ì„ ìˆœíšŒí•˜ë©° ê° ëŒ“ê¸€ í‘œì‹œ
   - `maxVisible`ì´ ìˆìœ¼ë©´ í•´ë‹¹ ê°œìˆ˜ë§Œ í‘œì‹œ
   - ì‚¬ìš©ìëª… Bold + ëŒ“ê¸€ ë‚´ìš©
   - ìƒëŒ€ ì‹œê°„ í‘œì‹œ (`formatRelativeTime` ì‚¬ìš©)

2. **ì‚­ì œ ë²„íŠ¼**
   - ë³¸ì¸ ëŒ“ê¸€ë§Œ í‘œì‹œ (`currentUserId`ì™€ `comment.user_id` ë¹„êµ)
   - â‹¯ ë©”ë‰´ ë˜ëŠ” ì‚­ì œ ì•„ì´ì½˜
   - í´ë¦­ ì‹œ ì‚­ì œ API í˜¸ì¶œ
   - Optimistic Update íŒ¨í„´ ì‚¬ìš©

3. **"ëª¨ë‘ ë³´ê¸°" ë§í¬**
   - `maxVisible`ì´ ìˆê³  ì „ì²´ ëŒ“ê¸€ ìˆ˜ê°€ ë” ë§ì„ ë•Œ í‘œì‹œ
   - í´ë¦­ ì‹œ `onShowAll` ì½œë°± í˜¸ì¶œ (ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°)

4. **ì‚¬ìš©ì ì •ë³´**
   - ì‚¬ìš©ìëª… (Bold, í´ë¦­ ì‹œ í”„ë¡œí•„ í˜ì´ì§€ë¡œ ì´ë™)
   - í”„ë¡œí•„ ì´ë¯¸ì§€ (ì„ íƒì , ë‚˜ì¤‘ì— êµ¬í˜„)

**ì½”ë“œ êµ¬ì¡°:**
```typescript
'use client';

import { useState } from 'react';
import Link from 'next/link';
import { MoreHorizontal, Trash2 } from 'lucide-react';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { Button } from '@/components/ui/button';
import { formatRelativeTime } from '@/lib/utils/time';
import type { CommentWithUser } from '@/lib/types';

interface CommentListProps {
  postId: string;
  comments: CommentWithUser[];
  maxVisible?: number;
  showAllLink?: boolean;
  onCommentDelete?: (commentId: string) => void;
  currentUserId?: string;
  onShowAll?: () => void;
}

export default function CommentList({
  postId,
  comments,
  maxVisible,
  showAllLink = true,
  onCommentDelete,
  currentUserId,
  onShowAll,
}: CommentListProps) {
  const [deletingId, setDeletingId] = useState<string | null>(null);

  const visibleComments = maxVisible
    ? comments.slice(0, maxVisible)
    : comments;

  const hasMore = maxVisible && comments.length > maxVisible;

  const handleDelete = async (commentId: string) => {
    if (deletingId) return;

    try {
      setDeletingId(commentId);

      const response = await fetch('/api/comments', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ comment_id: commentId }),
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || 'ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }

      // ì‚­ì œ ì„±ê³µ ì‹œ ì½œë°± í˜¸ì¶œ
      if (onCommentDelete) {
        onCommentDelete(commentId);
      }
    } catch (error) {
      console.error('ëŒ“ê¸€ ì‚­ì œ ì—ëŸ¬:', error);
      alert(error instanceof Error ? error.message : 'ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setDeletingId(null);
    }
  };

  if (comments.length === 0) {
    return null;
  }

  return (
    <div className="px-4 space-y-2">
      {hasMore && showAllLink && onShowAll && (
        <button
          onClick={onShowAll}
          className="text-text-secondary text-sm hover:text-text-primary"
        >
          ëŒ“ê¸€ {comments.length}ê°œ ëª¨ë‘ ë³´ê¸°
        </button>
      )}

      {visibleComments.map((comment) => (
        <div key={comment.id} className="flex items-start gap-2 group">
          <div className="flex-1 min-w-0">
            <div className="flex items-baseline gap-2 flex-wrap">
              <Link
                href={`/profile/${comment.user.id}`}
                className="font-bold text-text-primary text-sm hover:opacity-70"
              >
                {comment.user.name}
              </Link>
              <span className="text-text-primary text-sm break-words">
                {comment.content}
              </span>
            </div>
            <div className="flex items-center gap-2 mt-1">
              <span className="text-text-secondary text-xs">
                {formatRelativeTime(comment.created_at)}
              </span>
              {currentUserId === comment.user_id && (
                <button
                  onClick={() => handleDelete(comment.id)}
                  disabled={deletingId === comment.id}
                  className="text-text-secondary text-xs hover:text-red-500 disabled:opacity-50"
                >
                  {deletingId === comment.id ? 'ì‚­ì œ ì¤‘...' : 'ì‚­ì œ'}
                </button>
              )}
            </div>
          </div>
        </div>
      ))}
    </div>
  );
}
```

**ìŠ¤íƒ€ì¼ë§:**
- ëŒ“ê¸€ ê°„ê²©: `space-y-2`
- ì‚¬ìš©ìëª…: Bold, í´ë¦­ ê°€ëŠ¥
- ëŒ“ê¸€ ë‚´ìš©: ì¼ë°˜ í…ìŠ¤íŠ¸, ì¤„ë°”ê¿ˆ ì§€ì›
- ì‚­ì œ ë²„íŠ¼: ì‘ì€ í…ìŠ¤íŠ¸, í˜¸ë²„ ì‹œ ë¹¨ê°„ìƒ‰

---

## 3. CommentForm ì»´í¬ë„ŒíŠ¸ ìƒì„±

### 3.1 `components/comment/CommentForm.tsx` ìƒì„±

**íŒŒì¼ ê²½ë¡œ:** `components/comment/CommentForm.tsx`

**ê¸°ëŠ¥:**
- ëŒ“ê¸€ ì…ë ¥ í•„ë“œ ("ëŒ“ê¸€ ë‹¬ê¸°...")
- Enter í‚¤ ë˜ëŠ” "ê²Œì‹œ" ë²„íŠ¼ìœ¼ë¡œ ì œì¶œ
- ë¡œë”© ìƒíƒœ ê´€ë¦¬
- Optimistic Update íŒ¨í„´

**Props íƒ€ì…:**
```typescript
interface CommentFormProps {
  postId: string;
  onSubmit?: (comment: CommentWithUser) => void; // ì œì¶œ ì„±ê³µ ì‹œ ì½œë°±
  placeholder?: string;
  disabled?: boolean;
}
```

**ìƒíƒœ ê´€ë¦¬:**
- `content`: ì…ë ¥ëœ ëŒ“ê¸€ ë‚´ìš©
- `isSubmitting`: ì œì¶œ ì¤‘ ì—¬ë¶€
- `error`: ì—ëŸ¬ ë©”ì‹œì§€

**êµ¬í˜„ ì„¸ë¶€ì‚¬í•­:**

1. **ì…ë ¥ í•„ë“œ**
   - Textarea ë˜ëŠ” Input ì»´í¬ë„ŒíŠ¸ ì‚¬ìš©
   - Placeholder: "ëŒ“ê¸€ ë‹¬ê¸°..."
   - ìë™ í¬ì»¤ìŠ¤ (ì„ íƒì )

2. **ì œì¶œ ë°©ì‹**
   - Enter í‚¤: ì œì¶œ (Shift+EnterëŠ” ì¤„ë°”ê¿ˆ)
   - "ê²Œì‹œ" ë²„íŠ¼: ì œì¶œ
   - ë¹ˆ ë‚´ìš©ì¼ ë•ŒëŠ” ì œì¶œ ë¶ˆê°€

3. **API í˜¸ì¶œ**
   - `/api/comments` POST ìš”ì²­
   - ì„±ê³µ ì‹œ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
   - ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ

4. **ë¡œë”© ìƒíƒœ**
   - ì œì¶œ ì¤‘ì—ëŠ” ë²„íŠ¼ ë¹„í™œì„±í™”
   - ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ

**ì½”ë“œ êµ¬ì¡°:**
```typescript
'use client';

import { useState, useCallback, KeyboardEvent } from 'react';
import { Send, Loader2 } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import type { CommentWithUser } from '@/lib/types';

interface CommentFormProps {
  postId: string;
  onSubmit?: (comment: CommentWithUser) => void;
  placeholder?: string;
  disabled?: boolean;
}

export default function CommentForm({
  postId,
  onSubmit,
  placeholder = "ëŒ“ê¸€ ë‹¬ê¸°...",
  disabled = false,
}: CommentFormProps) {
  const [content, setContent] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleSubmit = useCallback(async () => {
    const trimmedContent = content.trim();
    
    if (!trimmedContent || isSubmitting || disabled) {
      return;
    }

    setIsSubmitting(true);
    setError(null);

    try {
      const response = await fetch('/api/comments', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          post_id: postId,
          content: trimmedContent,
        }),
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || 'ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }

      const data = await response.json();
      const newComment = data.comment;

      // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      setContent('');

      // ì„±ê³µ ì½œë°± í˜¸ì¶œ
      if (onSubmit) {
        onSubmit(newComment);
      }
    } catch (err) {
      setError(err instanceof Error ? err.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      console.error('ëŒ“ê¸€ ì‘ì„± ì—ëŸ¬:', err);
    } finally {
      setIsSubmitting(false);
    }
  }, [content, postId, isSubmitting, disabled, onSubmit]);

  const handleKeyDown = (e: KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSubmit();
    }
  };

  const canSubmit = content.trim().length > 0 && !isSubmitting && !disabled;

  return (
    <div className="px-4 py-3 border-t border-border">
      {error && (
        <div className="text-sm text-red-500 mb-2">{error}</div>
      )}
      <div className="flex items-center gap-2">
        <Input
          type="text"
          placeholder={placeholder}
          value={content}
          onChange={(e) => setContent(e.target.value)}
          onKeyDown={handleKeyDown}
          disabled={isSubmitting || disabled}
          className="flex-1"
        />
        <Button
          onClick={handleSubmit}
          disabled={!canSubmit}
          size="sm"
          variant="ghost"
          className="px-3"
        >
          {isSubmitting ? (
            <Loader2 className="w-4 h-4 animate-spin" />
          ) : (
            <Send className="w-4 h-4" />
          )}
        </Button>
      </div>
    </div>
  );
}
```

**ìŠ¤íƒ€ì¼ë§:**
- ì…ë ¥ í•„ë“œ: flex-1ë¡œ í™•ì¥
- ì œì¶œ ë²„íŠ¼: ì•„ì´ì½˜ë§Œ í‘œì‹œ (Send ì•„ì´ì½˜)
- ì—ëŸ¬ ë©”ì‹œì§€: ë¹¨ê°„ìƒ‰, ì‘ì€ í…ìŠ¤íŠ¸

---

## 4. PostCardì— ëŒ“ê¸€ ê¸°ëŠ¥ í†µí•©

### 4.1 `components/post/PostCard.tsx` ì—…ë°ì´íŠ¸

**ë³€ê²½ ì‚¬í•­:**

1. **ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ**
   - `useEffect`ë¡œ ê²Œì‹œë¬¼ì˜ ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ
   - ìµœì‹  2ê°œë§Œ ë¡œë“œ (PostCard ë¯¸ë¦¬ë³´ê¸°ìš©)
   - ëŒ“ê¸€ ì‘ì„±/ì‚­ì œ ì‹œ ëª©ë¡ ì—…ë°ì´íŠ¸

2. **CommentList í†µí•©**
   - `CommentList` ì»´í¬ë„ŒíŠ¸ ì¶”ê°€
   - `maxVisible={2}` ì„¤ì •
   - ì‚­ì œ ì½œë°± ì²˜ë¦¬

3. **CommentForm í†µí•©**
   - `CommentForm` ì»´í¬ë„ŒíŠ¸ ì¶”ê°€
   - ëŒ“ê¸€ ì‘ì„± ì„±ê³µ ì‹œ ëª©ë¡ ì—…ë°ì´íŠ¸

4. **ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸**
   - ëŒ“ê¸€ ì‘ì„± ì‹œ `commentsCount` ì¦ê°€
   - ëŒ“ê¸€ ì‚­ì œ ì‹œ `commentsCount` ê°ì†Œ

**ì½”ë“œ ë³€ê²½ ì˜ˆì‹œ:**
```typescript
// PostCard.tsxì— ì¶”ê°€
import { useState, useEffect, useCallback } from 'react';
import CommentList from '@/components/comment/CommentList';
import CommentForm from '@/components/comment/CommentForm';
import type { CommentWithUser } from '@/lib/types';

// ìƒíƒœ ì¶”ê°€
const [comments, setComments] = useState<CommentWithUser[]>([]);
const [commentsCount, setCommentsCount] = useState(post.comments_count);
const [isLoadingComments, setIsLoadingComments] = useState(false);

// ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ
useEffect(() => {
  const loadComments = async () => {
    if (post.comments_count === 0) return;
    
    setIsLoadingComments(true);
    try {
      const response = await fetch(
        `/api/comments?post_id=${post.id}&limit=2`
      );
      if (response.ok) {
        const data = await response.json();
        setComments(data.comments || []);
      }
    } catch (error) {
      console.error('ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨:', error);
    } finally {
      setIsLoadingComments(false);
    }
  };

  loadComments();
}, [post.id, post.comments_count]);

// ëŒ“ê¸€ ì‘ì„± í•¸ë“¤ëŸ¬
const handleCommentSubmit = useCallback((comment: CommentWithUser) => {
  setComments((prev) => {
    const newComments = [comment, ...prev];
    return newComments.slice(0, 2); // ìµœì‹  2ê°œë§Œ ìœ ì§€
  });
  setCommentsCount((prev) => prev + 1);
}, []);

// ëŒ“ê¸€ ì‚­ì œ í•¸ë“¤ëŸ¬
const handleCommentDelete = useCallback((commentId: string) => {
  setComments((prev) => prev.filter((c) => c.id !== commentId));
  setCommentsCount((prev) => Math.max(0, prev - 1));
}, []);

// PostCard ë Œë”ë§ ë¶€ë¶„ì— ì¶”ê°€
{/* ëŒ“ê¸€ ë¯¸ë¦¬ë³´ê¸° */}
{commentsCount > 0 && (
  <CommentList
    postId={post.id}
    comments={comments}
    maxVisible={2}
    showAllLink={commentsCount > 2}
    onCommentDelete={handleCommentDelete}
    currentUserId={currentUserId}
    onShowAll={() => {
      // ìƒì„¸ ëª¨ë‹¬ ì—´ê¸° (ë‚˜ì¤‘ì— êµ¬í˜„)
      console.log('Show all comments');
    }}
  />
)}

{/* ëŒ“ê¸€ ì…ë ¥ í¼ */}
<CommentForm
  postId={post.id}
  onSubmit={handleCommentSubmit}
  disabled={isLoadingComments}
/>
```

---

## 5. ì‘ì—… ìˆœì„œ

### ë‹¨ê³„ 1: API Route ìƒì„± (ìš°ì„ ìˆœìœ„: ë†’ìŒ)
1. `app/api/comments/route.ts` ìƒì„±
2. GET í•¸ë“¤ëŸ¬ êµ¬í˜„ (ì„ íƒì )
3. POST í•¸ë“¤ëŸ¬ êµ¬í˜„
4. DELETE í•¸ë“¤ëŸ¬ êµ¬í˜„
5. ì¸ì¦ ë° ì—ëŸ¬ ì²˜ë¦¬
6. í…ŒìŠ¤íŠ¸

### ë‹¨ê³„ 2: CommentList ì»´í¬ë„ŒíŠ¸ ìƒì„± (ìš°ì„ ìˆœìœ„: ë†’ìŒ)
1. `components/comment/CommentList.tsx` ìƒì„±
2. ëŒ“ê¸€ ë Œë”ë§ êµ¬í˜„
3. ì‚­ì œ ë²„íŠ¼ êµ¬í˜„
4. "ëª¨ë‘ ë³´ê¸°" ë§í¬ êµ¬í˜„
5. ìŠ¤íƒ€ì¼ë§

### ë‹¨ê³„ 3: CommentForm ì»´í¬ë„ŒíŠ¸ ìƒì„± (ìš°ì„ ìˆœìœ„: ë†’ìŒ)
1. `components/comment/CommentForm.tsx` ìƒì„±
2. ì…ë ¥ í•„ë“œ êµ¬í˜„
3. Enter í‚¤ ì œì¶œ êµ¬í˜„
4. API í˜¸ì¶œ í†µí•©
5. ë¡œë”© ìƒíƒœ ê´€ë¦¬

### ë‹¨ê³„ 4: PostCard í†µí•© (ìš°ì„ ìˆœìœ„: ì¤‘ê°„)
1. ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ ë¡œì§ êµ¬í˜„
2. CommentList í†µí•©
3. CommentForm í†µí•©
4. ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸ ë¡œì§ êµ¬í˜„

### ë‹¨ê³„ 5: í…ŒìŠ¤íŠ¸ ë° ë‹¤ë“¬ê¸° (ìš°ì„ ìˆœìœ„: ì¤‘ê°„)
1. ëŒ“ê¸€ ì‘ì„±/ì‚­ì œ í…ŒìŠ¤íŠ¸
2. UI/UX ê°œì„ 
3. ì—ëŸ¬ ì²˜ë¦¬ ê°œì„ 
4. ì ‘ê·¼ì„± ê°œì„ 

---

## 6. ì°¸ê³  íŒŒì¼

- [PRD.md](../docs/PRD.md) - ëŒ“ê¸€ ê¸°ëŠ¥ ì •ì˜ (285-291ì¤„, 462-472ì¤„)
- [TODO.md](../docs/TODO.md) - ëŒ“ê¸€ ê¸°ëŠ¥ TODO (120-137ì¤„)
- [db.sql](../../supabase/migrations/db.sql) - comments í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ (91-114ì¤„)
- [lib/types.ts](../../lib/types.ts) - TypeScript íƒ€ì… ì •ì˜ (Comment, CommentWithUser)
- [lib/supabase/server.ts](../../lib/supabase/server.ts) - Supabase ì„œë²„ í´ë¼ì´ì–¸íŠ¸
- [components/post/PostCard.tsx](../../components/post/PostCard.tsx) - PostCard ì»´í¬ë„ŒíŠ¸
- [lib/utils/time.ts](../../lib/utils/time.ts) - formatRelativeTime í•¨ìˆ˜

---

## 7. ì£¼ì˜ì‚¬í•­

1. **ëŒ“ê¸€ ë‚´ìš© ê²€ì¦**: ë¹ˆ ë¬¸ìì—´ ë˜ëŠ” ê³µë°±ë§Œ ìˆëŠ” ê²½ìš° ê±°ë¶€
2. **ì‚­ì œ ê¶Œí•œ**: ë³¸ì¸ ëŒ“ê¸€ë§Œ ì‚­ì œ ê°€ëŠ¥ (403 ì—ëŸ¬)
3. **Optimistic Update**: ëŒ“ê¸€ ì‘ì„±/ì‚­ì œ ì‹œ ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸
4. **ëŒ“ê¸€ ìˆ˜ ë™ê¸°í™”**: ëŒ“ê¸€ ì‘ì„±/ì‚­ì œ ì‹œ `commentsCount` ì—…ë°ì´íŠ¸
5. **ì„±ëŠ¥**: ëŒ“ê¸€ ëª©ë¡ì€ í•„ìš”í•  ë•Œë§Œ ë¡œë“œ (lazy loading)
6. **ì ‘ê·¼ì„±**: í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜, ìŠ¤í¬ë¦° ë¦¬ë” ì§€ì›

---

## 8. í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] API Route í…ŒìŠ¤íŠ¸
  - [ ] ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ì â†’ 401
  - [ ] ì˜ëª»ëœ post_id â†’ 400 ë˜ëŠ” 404
  - [ ] ë¹ˆ ëŒ“ê¸€ ë‚´ìš© â†’ 400
  - [ ] ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²Œì‹œë¬¼ â†’ 404
  - [ ] ì •ìƒ ëŒ“ê¸€ ì‘ì„± â†’ 200
  - [ ] ë³¸ì¸ì´ ì•„ë‹Œ ëŒ“ê¸€ ì‚­ì œ â†’ 403
  - [ ] ì •ìƒ ëŒ“ê¸€ ì‚­ì œ â†’ 200

- [ ] CommentList ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸
  - [ ] ëŒ“ê¸€ ëª©ë¡ í‘œì‹œ
  - [ ] ìµœì‹  2ê°œë§Œ í‘œì‹œ (maxVisible)
  - [ ] "ëª¨ë‘ ë³´ê¸°" ë§í¬ í‘œì‹œ
  - [ ] ì‚­ì œ ë²„íŠ¼ (ë³¸ì¸ë§Œ)
  - [ ] ì‚­ì œ ê¸°ëŠ¥ ë™ì‘

- [ ] CommentForm ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸
  - [ ] ëŒ“ê¸€ ì…ë ¥
  - [ ] Enter í‚¤ ì œì¶œ
  - [ ] "ê²Œì‹œ" ë²„íŠ¼ ì œì¶œ
  - [ ] ë¹ˆ ë‚´ìš© ì œì¶œ ë°©ì§€
  - [ ] ë¡œë”© ìƒíƒœ í‘œì‹œ

- [ ] PostCard í†µí•© í…ŒìŠ¤íŠ¸
  - [ ] ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ
  - [ ] ëŒ“ê¸€ ì‘ì„± í›„ ëª©ë¡ ì—…ë°ì´íŠ¸
  - [ ] ëŒ“ê¸€ ì‚­ì œ í›„ ëª©ë¡ ì—…ë°ì´íŠ¸
  - [ ] ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸

- [ ] í†µí•© í…ŒìŠ¤íŠ¸
  - [ ] ëŒ“ê¸€ ì‘ì„± í›„ í”¼ë“œì— ë°˜ì˜
  - [ ] ëŒ“ê¸€ ì‚­ì œ í›„ í”¼ë“œì— ë°˜ì˜
  - [ ] ì—¬ëŸ¬ ê²Œì‹œë¬¼ì—ì„œ ëŒ“ê¸€ ë™ì‹œ ì‚¬ìš©

---

## 9. ì˜ˆìƒ ì†Œìš” ì‹œê°„

- API Route ìƒì„±: 2-3ì‹œê°„
- CommentList ì»´í¬ë„ŒíŠ¸: 2-3ì‹œê°„
- CommentForm ì»´í¬ë„ŒíŠ¸: 1-2ì‹œê°„
- PostCard í†µí•©: 2-3ì‹œê°„
- í…ŒìŠ¤íŠ¸ ë° ë‹¤ë“¬ê¸°: 1-2ì‹œê°„

**ì´ ì˜ˆìƒ ì‹œê°„: 8-13ì‹œê°„**

---

## 10. ì¶”ê°€ ê°œì„  ì‚¬í•­ (ì„ íƒì )

1. **ëŒ“ê¸€ ìˆ˜ì • ê¸°ëŠ¥**
   - ëŒ“ê¸€ ìˆ˜ì • API ë° UI (ë‚˜ì¤‘ì— êµ¬í˜„)

2. **ëŒ“ê¸€ ì¢‹ì•„ìš” ê¸°ëŠ¥**
   - ëŒ“ê¸€ì— ì¢‹ì•„ìš” ì¶”ê°€ (ë‚˜ì¤‘ì— êµ¬í˜„)

3. **ëŒ“ê¸€ ë‹µê¸€ ê¸°ëŠ¥**
   - ëŒ€ëŒ“ê¸€ ì‘ì„± (ë‚˜ì¤‘ì— êµ¬í˜„)

4. **ëŒ“ê¸€ ë¬´í•œ ìŠ¤í¬ë¡¤**
   - ë§ì€ ëŒ“ê¸€ì´ ìˆì„ ë•Œ ìŠ¤í¬ë¡¤ë¡œ ë¡œë“œ

5. **ëŒ“ê¸€ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸**
   - WebSocket ë˜ëŠ” Pollingìœ¼ë¡œ ì‹¤ì‹œê°„ ë™ê¸°í™”

