# 홈 피드 페이지 개발 계획

## 개요

Instagram 스타일의 홈 피드 페이지를 구현합니다. 게시물 목록을 시간 역순으로 표시하고, 무한 스크롤을 통해 페이지네이션을 처리합니다.

## 1. API Route 생성: 게시물 목록 조회

### 1.1 `app/api/posts/route.ts` 생성

**기능:**
- GET: 게시물 목록 조회 (시간 역순 정렬)
- 페이지네이션 지원 (limit, offset 또는 cursor 기반)
- 선택적 userId 파라미터 (프로필 페이지용)
- 현재 사용자의 좋아요 상태 포함

**구현 세부사항:**

1. **인증 확인**
   - Clerk `auth()`로 현재 사용자 확인
   - 인증되지 않은 경우 401 반환

2. **쿼리 파라미터 처리**
   - `limit`: 페이지당 게시물 수 (기본값: 10)
   - `offset`: 건너뛸 게시물 수 (기본값: 0)
   - `userId`: 특정 사용자의 게시물만 조회 (선택적)

3. **데이터베이스 쿼리**
   - `post_stats` 뷰 사용하여 좋아요/댓글 수 포함
   - `users` 테이블과 JOIN하여 사용자 정보 포함
   - `created_at DESC` 정렬
   - `limit`과 `offset`으로 페이지네이션

4. **좋아요 상태 확인**
   - 현재 사용자가 각 게시물에 좋아요를 눌렀는지 확인
   - `likes` 테이블에서 현재 사용자 ID로 조회
   - `is_liked` 필드로 응답에 포함

5. **응답 형식**
   ```typescript
   {
     data: PostWithUser[],
     has_more: boolean,
     next_offset?: number
   }
   ```

**코드 구조:**
```typescript
import { NextRequest, NextResponse } from "next/server";
import { auth } from "@clerk/nextjs/server";
import { createClerkSupabaseClient } from "@/lib/supabase/server";
import type { PostWithUser } from "@/lib/types";

export async function GET(request: NextRequest) {
  // 1. 인증 확인
  // 2. 쿼리 파라미터 파싱
  // 3. Supabase 클라이언트 생성
  // 4. 게시물 조회 (post_stats 뷰 사용)
  // 5. 사용자 정보 JOIN
  // 6. 좋아요 상태 확인
  // 7. 응답 반환
}
```

**에러 처리:**
- 인증 실패: 401 Unauthorized
- 데이터베이스 에러: 500 Internal Server Error
- 잘못된 파라미터: 400 Bad Request

## 2. PostCard 컴포넌트

### 2.1 `components/post/PostCard.tsx` 생성

**구성 요소:**

1. **헤더 (60px 높이)**
   - 프로필 이미지: 32px 원형 (Clerk UserButton 또는 Avatar 컴포넌트)
   - 사용자명: Bold, 클릭 시 프로필 페이지로 이동
   - 시간: 상대 시간 표시 (예: "3시간 전", "2일 전")
   - ⋯ 메뉴: 우측 정렬 (본인 게시물만 삭제 옵션, 나중에 구현)

2. **이미지 영역**
   - 1:1 정사각형 비율 유지
   - Next.js Image 컴포넌트 사용 (최적화)
   - 더블탭 좋아요 기능 (모바일, 나중에 구현)
   - Lazy loading

3. **액션 버튼 (48px 높이)**
   - 좋아요 버튼: ❤️ (빈 하트 ↔ 빨간 하트)
   - 댓글 버튼: 💬 (클릭 시 댓글 입력창 포커스)
   - 공유 버튼: ✈️ (1차 제외, UI만)
   - 북마크 버튼: 🔖 (우측 정렬, 1차 제외, UI만)

4. **컨텐츠 영역**
   - 좋아요 수: Bold, "좋아요 1,234개" 형식
   - 캡션:
     - 사용자명 Bold + 내용
     - 2줄 초과 시 "... 더 보기" 버튼 (클릭 시 전체 표시)
   - 댓글 미리보기:
     - "댓글 15개 모두 보기" 링크 (클릭 시 상세 모달)
     - 최신 2개만 표시 (사용자명 + 내용)

5. **댓글 입력창**
   - "댓글 달기..." placeholder
   - Enter 키 또는 "게시" 버튼으로 제출 (나중에 구현)

**Props 타입:**
```typescript
interface PostCardProps {
  post: PostWithUser;
  onLike?: (postId: string) => void;
  onComment?: (postId: string, content: string) => void;
  onDelete?: (postId: string) => void;
}
```

**스타일링:**
- 배경: `bg-card-background` (#FFFFFF)
- 테두리: `border border-border` (#DBDBDB)
- 패딩: 적절한 여백
- 반응형: Mobile에서 전체 너비

**상대 시간 표시 함수:**
```typescript
function formatRelativeTime(dateString: string): string {
  // "3시간 전", "2일 전", "1주 전" 등으로 변환
}
```

## 3. PostCardSkeleton 컴포넌트

### 3.1 `components/post/PostCardSkeleton.tsx` 생성

**구성 요소:**
- 헤더 스켈레톤: 원형 프로필 + 직사각형 텍스트
- 이미지 스켈레톤: 정사각형 회색 박스
- 액션 버튼 스켈레톤: 작은 원형 박스들
- 컨텐츠 스켈레톤: 여러 줄의 직사각형 박스

**Shimmer 효과:**
- Tailwind CSS `animate-pulse` 사용
- 또는 커스텀 shimmer 애니메이션 (gradient 이동)

**스타일링:**
- PostCard와 동일한 레이아웃
- 회색 배경 (`bg-gray-200` 또는 `bg-gray-100`)
- 적절한 높이와 패딩

## 4. PostFeed 컴포넌트

### 4.1 `components/post/PostFeed.tsx` 생성

**기능:**
- 게시물 목록 렌더링
- 무한 스크롤 (Intersection Observer 사용)
- 페이지네이션 (10개씩 로드)
- 로딩 상태 관리
- 에러 처리

**구현 세부사항:**

1. **상태 관리**
   - `posts`: 게시물 배열
   - `loading`: 초기 로딩 상태
   - `loadingMore`: 추가 로딩 상태
   - `hasMore`: 더 불러올 게시물이 있는지
   - `error`: 에러 메시지

2. **데이터 페칭**
   - `useEffect`로 초기 데이터 로드
   - `/api/posts` GET 요청
   - 쿼리 파라미터: `limit=10`, `offset=0`

3. **무한 스크롤**
   - Intersection Observer API 사용
   - 하단 감지 요소 (sentinel) 생성
   - 하단 도달 시 다음 페이지 로드
   - `offset`을 증가시켜 다음 페이지 요청

4. **로딩 UI**
   - 초기 로딩: PostCardSkeleton 여러 개 표시
   - 추가 로딩: 하단에 PostCardSkeleton 1-2개 표시

5. **에러 처리**
   - 에러 발생 시 사용자 친화적 메시지 표시
   - 재시도 버튼 제공

**코드 구조:**
```typescript
'use client';

import { useEffect, useRef, useState } from 'react';
import PostCard from './PostCard';
import PostCardSkeleton from './PostCardSkeleton';
import type { PostWithUser } from '@/lib/types';

export default function PostFeed() {
  const [posts, setPosts] = useState<PostWithUser[]>([]);
  const [loading, setLoading] = useState(true);
  const [loadingMore, setLoadingMore] = useState(false);
  const [hasMore, setHasMore] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [offset, setOffset] = useState(0);
  const sentinelRef = useRef<HTMLDivElement>(null);

  // 초기 데이터 로드
  useEffect(() => {
    loadPosts(0);
  }, []);

  // 무한 스크롤 설정
  useEffect(() => {
    // Intersection Observer 설정
  }, [hasMore, loadingMore]);

  const loadPosts = async (currentOffset: number) => {
    // API 호출 및 상태 업데이트
  };

  return (
    <div className="space-y-6">
      {/* 게시물 목록 */}
      {/* 로딩 UI */}
      {/* 에러 메시지 */}
      {/* Sentinel (하단 감지 요소) */}
    </div>
  );
}
```

## 5. 홈 페이지 업데이트

### 5.1 `app/(main)/page.tsx` 업데이트

**변경 사항:**
- PostFeed 컴포넌트 통합
- 배경색 `#FAFAFA` 설정 (이미 레이아웃에서 처리됨)
- 간단한 헤더 제거 (필요시)

**코드:**
```typescript
import PostFeed from '@/components/post/PostFeed';

export default function HomePage() {
  return (
    <div className="py-4">
      <PostFeed />
    </div>
  );
}
```

## 6. 유틸리티 함수

### 6.1 `lib/utils/time.ts` 생성 (선택적)

**기능:**
- 상대 시간 포맷팅 함수
- 예: "방금 전", "3분 전", "1시간 전", "2일 전", "1주 전", "1개월 전"

**구현:**
```typescript
export function formatRelativeTime(dateString: string): string {
  const date = new Date(dateString);
  const now = new Date();
  const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);

  if (diffInSeconds < 60) return '방금 전';
  if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}분 전`;
  if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}시간 전`;
  if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}일 전`;
  if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 604800)}주 전`;
  return `${Math.floor(diffInSeconds / 2592000)}개월 전`;
}
```

## 7. 타입 정의 확인

### 7.1 `lib/types.ts` 확인

**필요한 타입:**
- `PostWithUser`: 이미 정의됨 ✅
- `PostWithStats`: 이미 정의됨 ✅
- `ApiResponse<T>`: 이미 정의됨 ✅
- `PaginatedResponse<T>`: 이미 정의됨 ✅

## 8. 아이콘 및 UI 컴포넌트

### 8.1 필요한 아이콘 (lucide-react)
- `Heart`: 좋아요 버튼
- `MessageCircle`: 댓글 버튼
- `Send`: 공유 버튼 (1차 제외)
- `Bookmark`: 북마크 버튼 (1차 제외)
- `MoreHorizontal`: ⋯ 메뉴
- `User`: 프로필 이미지 (대체)

### 8.2 필요한 shadcn/ui 컴포넌트
- `Avatar`: 프로필 이미지 (이미 설치되어 있을 수 있음)
- `Button`: 버튼 (이미 설치되어 있을 수 있음)
- `Skeleton`: 스켈레톤 UI (이미 설치되어 있을 수 있음)

**확인 및 설치:**
```bash
pnpx shadcn@latest add avatar
pnpx shadcn@latest add skeleton
```

## 9. 데이터베이스 쿼리 최적화

### 9.1 인덱스 확인
- `idx_posts_created_at`: 이미 생성됨 ✅
- `idx_posts_user_id`: 이미 생성됨 ✅
- `post_stats` 뷰: 이미 생성됨 ✅

### 9.2 쿼리 성능
- `post_stats` 뷰 사용으로 JOIN 최소화
- `LIMIT`과 `OFFSET`으로 페이지네이션
- 필요한 컬럼만 SELECT

## 10. 에러 핸들링

### 10.1 API Route 에러 처리
- 인증 실패: 401 반환
- 데이터베이스 에러: 500 반환, 에러 로그 기록
- 잘못된 파라미터: 400 반환, 명확한 에러 메시지

### 10.2 클라이언트 에러 처리
- 네트워크 에러: 재시도 버튼 제공
- API 에러: 사용자 친화적 메시지 표시
- 빈 상태: "게시물이 없습니다" 메시지

## 작업 순서

1. **API Route 생성** (1단계)
   - `app/api/posts/route.ts` 생성
   - GET 핸들러 구현
   - 인증 및 쿼리 파라미터 처리
   - 데이터베이스 쿼리 구현
   - 테스트

2. **PostCardSkeleton 생성** (2단계)
   - `components/post/PostCardSkeleton.tsx` 생성
   - Shimmer 효과 적용
   - PostCard와 동일한 레이아웃

3. **PostCard 컴포넌트 생성** (3단계)
   - `components/post/PostCard.tsx` 생성
   - 헤더 구현
   - 이미지 영역 구현
   - 액션 버튼 구현 (좋아요는 나중에)
   - 컨텐츠 영역 구현
   - 상대 시간 표시 함수 구현

4. **PostFeed 컴포넌트 생성** (4단계)
   - `components/post/PostFeed.tsx` 생성
   - 상태 관리 구현
   - 초기 데이터 로드 구현
   - 무한 스크롤 구현
   - 에러 처리 구현

5. **홈 페이지 업데이트** (5단계)
   - `app/(main)/page.tsx` 업데이트
   - PostFeed 통합

6. **스타일링 및 다듬기** (6단계)
   - Instagram 디자인에 맞게 스타일 조정
   - 반응형 확인
   - 애니메이션 추가

## 참고 파일

- [docs/PRD.md](docs/PRD.md) - PostCard 디자인 및 홈 피드 기능 정의 (106-156줄, 267-276줄)
- [docs/TODO.md](docs/TODO.md) - 홈 피드 페이지 TODO (64-85줄)
- [supabase/migrations/db.sql](supabase/migrations/db.sql) - 데이터베이스 스키마
- [lib/types.ts](lib/types.ts) - TypeScript 타입 정의
- [lib/supabase/server.ts](lib/supabase/server.ts) - Supabase 서버 클라이언트

## 주의사항

1. **좋아요 기능**: 이 단계에서는 UI만 구현하고, 실제 좋아요 기능은 다음 단계에서 구현합니다.
2. **댓글 기능**: 이 단계에서는 UI만 구현하고, 실제 댓글 작성 기능은 다음 단계에서 구현합니다.
3. **게시물 삭제**: ⋯ 메뉴는 UI만 구현하고, 삭제 기능은 나중에 구현합니다.
4. **상대 시간**: 한국어로 표시 ("3시간 전", "2일 전" 등).
5. **이미지 최적화**: Next.js Image 컴포넌트 사용 필수.
6. **무한 스크롤**: Intersection Observer 사용, 성능 고려.

