# 좋아요 기능 개발 계획

## 개요

Instagram 스타일의 좋아요 기능을 구현합니다. 사용자가 게시물에 좋아요를 추가/제거할 수 있으며, 클릭 애니메이션과 더블탭 좋아요 기능을 포함합니다.

## 1. API Route 생성: 좋아요 추가/제거

### 1.1 `app/api/likes/route.ts` 생성

**기능:**
- POST: 좋아요 추가
- DELETE: 좋아요 제거
- 인증 검증 (Clerk)
- 중복 좋아요 방지 (DB 제약조건 활용)
- 좋아요 수 업데이트

**구현 세부사항:**

#### POST 핸들러 (좋아요 추가)

1. **인증 확인**
   - Clerk `auth()`로 현재 사용자 확인
   - 인증되지 않은 경우 401 반환

2. **요청 본문 파싱**
   - `post_id`: 좋아요를 추가할 게시물 ID (UUID)
   - 필수 필드 검증

3. **사용자 ID 조회**
   - Clerk `userId`로 Supabase `users` 테이블에서 사용자 UUID 조회
   - 사용자가 존재하지 않으면 404 반환

4. **게시물 존재 확인**
   - `posts` 테이블에서 `post_id` 확인
   - 존재하지 않으면 404 반환

5. **중복 좋아요 확인**
   - `likes` 테이블에서 `(post_id, user_id)` 조합 확인
   - 이미 좋아요가 있으면 409 Conflict 반환 (또는 무시)

6. **좋아요 추가**
   - `likes` 테이블에 레코드 삽입
   - DB 제약조건 (`UNIQUE(post_id, user_id)`)으로 중복 방지

7. **응답 반환**
   ```typescript
   {
     success: true,
     like: {
       id: string,
       post_id: string,
       user_id: string,
       created_at: string
     }
   }
   ```

#### DELETE 핸들러 (좋아요 제거)

1. **인증 확인**
   - Clerk `auth()`로 현재 사용자 확인
   - 인증되지 않은 경우 401 반환

2. **요청 본문 파싱**
   - `post_id`: 좋아요를 제거할 게시물 ID (UUID)
   - 필수 필드 검증

3. **사용자 ID 조회**
   - Clerk `userId`로 Supabase `users` 테이블에서 사용자 UUID 조회

4. **좋아요 제거**
   - `likes` 테이블에서 `(post_id, user_id)` 조합으로 삭제
   - 존재하지 않으면 404 반환 (또는 무시)

5. **응답 반환**
   ```typescript
   {
     success: true,
     message: "Like removed"
   }
   ```

**코드 구조:**
```typescript
import { NextRequest, NextResponse } from "next/server";
import { auth } from "@clerk/nextjs/server";
import { createClerkSupabaseClient } from "@/lib/supabase/server";
import type { Like } from "@/lib/types";

export async function POST(request: NextRequest) {
  try {
    // 1. 인증 확인
    // 2. 요청 본문 파싱
    // 3. 사용자 ID 조회
    // 4. 게시물 존재 확인
    // 5. 중복 좋아요 확인
    // 6. 좋아요 추가
    // 7. 응답 반환
  } catch (error) {
    // 에러 처리
  }
}

export async function DELETE(request: NextRequest) {
  try {
    // 1. 인증 확인
    // 2. 요청 본문 파싱
    // 3. 사용자 ID 조회
    // 4. 좋아요 제거
    // 5. 응답 반환
  } catch (error) {
    // 에러 처리
  }
}
```

**에러 처리:**
- 인증 실패: 401 Unauthorized
- 게시물/사용자 없음: 404 Not Found
- 중복 좋아요: 409 Conflict (또는 무시)
- 데이터베이스 에러: 500 Internal Server Error
- 잘못된 요청: 400 Bad Request

**유틸리티 함수:**
```typescript
// Clerk userId로 Supabase user_id 조회
async function getSupabaseUserId(clerkUserId: string): Promise<string | null> {
  const supabase = createClerkSupabaseClient();
  const { data, error } = await supabase
    .from("users")
    .select("id")
    .eq("clerk_id", clerkUserId)
    .single();
  
  if (error || !data) return null;
  return data.id;
}
```

## 2. LikeButton 컴포넌트

### 2.1 `components/post/LikeButton.tsx` 생성

**기능:**
- 빈 하트 ↔ 빨간 하트 상태 관리
- 클릭 애니메이션 (scale 1.3 → 1, 0.15초)
- 더블탭 좋아요 (모바일, 큰 하트 fade in/out, 1초)
- API 호출 및 상태 업데이트
- 로딩 상태 관리

**Props 타입:**
```typescript
interface LikeButtonProps {
  postId: string;
  initialLiked: boolean;
  initialLikesCount: number;
  onLikeChange?: (liked: boolean, newCount: number) => void;
  showCount?: boolean; // 좋아요 수 표시 여부 (PostCard에서 처리)
  size?: "sm" | "md" | "lg"; // 아이콘 크기
  enableDoubleTap?: boolean; // 더블탭 활성화 여부 (모바일)
}
```

**상태 관리:**
- `liked`: 현재 좋아요 상태
- `likesCount`: 좋아요 수
- `isAnimating`: 클릭 애니메이션 중인지
- `isDoubleTapAnimating`: 더블탭 애니메이션 중인지
- `isLoading`: API 호출 중인지

**구현 세부사항:**

1. **하트 아이콘**
   - `liked` 상태에 따라 `Heart` (빈) 또는 `Heart` (채워진) 표시
   - 빨간색: `#ed4956` (`--like` 변수)
   - 크기: 기본 24px, props로 조정 가능

2. **클릭 핸들러**
   - 클릭 시 즉시 UI 업데이트 (Optimistic Update)
   - API 호출 (`/api/likes` POST 또는 DELETE)
   - 성공 시 상태 유지, 실패 시 롤백

3. **클릭 애니메이션**
   - 클릭 시 `scale(1.3)` → `scale(1)` (0.15초)
   - CSS transition 사용
   - `isAnimating` 상태로 애니메이션 중 중복 클릭 방지

4. **더블탭 좋아요 (모바일)**
   - 이미지 영역에서 더블탭 감지 (PostCard에서 처리)
   - 큰 하트 아이콘 표시 (중앙, 80px)
   - `fade in` (0.2초) → `fade out` (0.8초)
   - 애니메이션 중에는 클릭 이벤트 무시

5. **로딩 상태**
   - API 호출 중에는 버튼 비활성화 또는 스피너 표시
   - 에러 발생 시 토스트 메시지 (선택적)

**코드 구조:**
```typescript
'use client';

import { useState, useCallback } from 'react';
import { Heart } from 'lucide-react';
import { cn } from '@/lib/utils';

export default function LikeButton({
  postId,
  initialLiked,
  initialLikesCount,
  onLikeChange,
  size = 'md',
  enableDoubleTap = false,
}: LikeButtonProps) {
  const [liked, setLiked] = useState(initialLiked);
  const [likesCount, setLikesCount] = useState(initialLikesCount);
  const [isAnimating, setIsAnimating] = useState(false);
  const [isDoubleTapAnimating, setIsDoubleTapAnimating] = useState(false);
  const [isLoading, setIsLoading] = useState(false);

  const handleClick = useCallback(async () => {
    // Optimistic Update
    // API 호출
    // 상태 업데이트
  }, [postId, liked]);

  const handleDoubleTap = useCallback(async () => {
    // 더블탭 애니메이션
    // 좋아요 추가 (아직 좋아요하지 않은 경우)
  }, [postId, liked]);

  return (
    <button
      onClick={handleClick}
      className={cn(
        "transition-transform duration-150",
        isAnimating && "scale-[1.3]"
      )}
      disabled={isLoading}
    >
      <Heart
        className={cn(
          size === 'sm' && 'w-5 h-5',
          size === 'md' && 'w-6 h-6',
          size === 'lg' && 'w-8 h-8',
          liked ? 'fill-like text-like' : 'text-text-primary'
        )}
      />
    </button>
  );
}
```

**더블탭 애니메이션 컴포넌트:**
```typescript
// PostCard에서 사용할 큰 하트 오버레이
<div
  className={cn(
    "absolute inset-0 flex items-center justify-center pointer-events-none",
    "transition-opacity duration-200",
    isDoubleTapAnimating ? "opacity-100" : "opacity-0"
  )}
>
  <Heart className="w-20 h-20 fill-like text-like" />
</div>
```

**스타일링:**
- 클릭 애니메이션: `transition-transform duration-150`
- 더블탭 애니메이션: `transition-opacity duration-200` (fade in), `duration-800` (fade out)
- 호버 효과: `hover:opacity-80`
- 비활성화: `disabled:opacity-50 disabled:cursor-not-allowed`

## 3. PostCard에 LikeButton 통합

### 3.1 `components/post/PostCard.tsx` 업데이트

**변경 사항:**

1. **LikeButton 통합**
   - 액션 버튼 영역에 LikeButton 추가
   - `initialLiked` prop에 `post.is_liked` 전달
   - `initialLikesCount` prop에 `post.likes_count` 전달

2. **더블탭 좋아요 구현**
   - 이미지 영역에 더블탭 이벤트 리스너 추가
   - 모바일에서만 활성화 (또는 항상 활성화)
   - 더블탭 시 LikeButton의 `handleDoubleTap` 호출

3. **좋아요 수 표시**
   - 좋아요 수를 Bold로 표시
   - "좋아요 1,234개" 형식
   - `onLikeChange` 콜백으로 실시간 업데이트

4. **상태 동기화**
   - LikeButton의 상태 변경 시 PostCard의 `post` 상태 업데이트
   - 또는 부모 컴포넌트(PostFeed)에서 상태 관리

**코드 구조:**
```typescript
'use client';

import { useState, useRef } from 'react';
import LikeButton from './LikeButton';
import type { PostWithUser } from '@/lib/types';

interface PostCardProps {
  post: PostWithUser;
  onLikeChange?: (postId: string, liked: boolean, newCount: number) => void;
}

export default function PostCard({ post, onLikeChange }: PostCardProps) {
  const [currentPost, setCurrentPost] = useState(post);
  const lastTapRef = useRef<number>(0);

  const handleDoubleTap = () => {
    const now = Date.now();
    const DOUBLE_TAP_DELAY = 300; // 300ms 내 더블탭

    if (now - lastTapRef.current < DOUBLE_TAP_DELAY) {
      // 더블탭 감지
      // LikeButton의 handleDoubleTap 호출
    }

    lastTapRef.current = now;
  };

  const handleLikeChange = (liked: boolean, newCount: number) => {
    setCurrentPost({
      ...currentPost,
      is_liked: liked,
      likes_count: newCount,
    });
    onLikeChange?.(currentPost.id, liked, newCount);
  };

  return (
    <div className="bg-card-background border border-border rounded-lg">
      {/* 헤더 */}
      
      {/* 이미지 영역 (더블탭 이벤트) */}
      <div
        onDoubleClick={handleDoubleTap}
        className="relative"
      >
        <Image src={currentPost.image_url} alt="Post" />
        {/* 더블탭 애니메이션 오버레이 */}
      </div>

      {/* 액션 버튼 */}
      <div className="flex items-center gap-4 px-4 py-3">
        <LikeButton
          postId={currentPost.id}
          initialLiked={currentPost.is_liked ?? false}
          initialLikesCount={currentPost.likes_count}
          onLikeChange={handleLikeChange}
          enableDoubleTap={true}
        />
        {/* 다른 버튼들 */}
      </div>

      {/* 좋아요 수 */}
      <div className="px-4 pb-2">
        <span className="font-bold text-text-primary">
          좋아요 {currentPost.likes_count.toLocaleString()}개
        </span>
      </div>

      {/* 캡션 및 댓글 */}
    </div>
  );
}
```

## 4. 좋아요 수 포맷팅

### 4.1 `lib/utils/format.ts` 생성 (선택적)

**기능:**
- 좋아요 수를 읽기 쉬운 형식으로 변환
- 예: 1234 → "1,234", 12345 → "12.3K", 1234567 → "1.2M"

**구현:**
```typescript
export function formatLikesCount(count: number): string {
  if (count < 1000) {
    return count.toLocaleString();
  } else if (count < 1000000) {
    return `${(count / 1000).toFixed(1)}K`;
  } else {
    return `${(count / 1000000).toFixed(1)}M`;
  }
}
```

**사용:**
- PostCard에서 좋아요 수 표시 시 사용
- 또는 간단하게 `toLocaleString()` 사용

## 5. API 호출 유틸리티

### 5.1 `lib/api/likes.ts` 생성 (선택적)

**기능:**
- 좋아요 추가/제거 API 호출 함수
- 에러 처리 및 타입 안정성

**구현:**
```typescript
import type { ApiResponse, Like } from '@/lib/types';

export async function addLike(postId: string): Promise<ApiResponse<Like>> {
  try {
    const response = await fetch('/api/likes', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ post_id: postId }),
    });

    if (!response.ok) {
      const error = await response.json();
      return { data: null, error: error.error || 'Failed to add like' };
    }

    const data = await response.json();
    return { data: data.like, error: null };
  } catch (error) {
    return { data: null, error: 'Network error' };
  }
}

export async function removeLike(postId: string): Promise<ApiResponse<void>> {
  try {
    const response = await fetch('/api/likes', {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ post_id: postId }),
    });

    if (!response.ok) {
      const error = await response.json();
      return { data: null, error: error.error || 'Failed to remove like' };
    }

    return { data: undefined, error: null };
  } catch (error) {
    return { data: null, error: 'Network error' };
  }
}
```

## 6. PostFeed 상태 업데이트

### 6.1 `components/post/PostFeed.tsx` 업데이트

**변경 사항:**

1. **좋아요 상태 업데이트 핸들러**
   - PostCard의 `onLikeChange` 콜백 처리
   - `posts` 배열에서 해당 게시물 찾아서 업데이트

2. **상태 동기화**
   - LikeButton의 상태 변경 시 PostFeed의 `posts` 상태 업데이트
   - 다른 PostCard에도 동일한 게시물이 있으면 동기화

**코드 구조:**
```typescript
const handleLikeChange = useCallback((postId: string, liked: boolean, newCount: number) => {
  setPosts((prevPosts) =>
    prevPosts.map((post) =>
      post.id === postId
        ? { ...post, is_liked: liked, likes_count: newCount }
        : post
    )
  );
}, []);
```

## 7. 애니메이션 세부사항

### 7.1 클릭 애니메이션

**CSS:**
```css
.like-button {
  transition: transform 0.15s ease-out;
}

.like-button.animating {
  transform: scale(1.3);
}
```

**JavaScript:**
```typescript
const handleClick = async () => {
  setIsAnimating(true);
  // API 호출
  setTimeout(() => setIsAnimating(false), 150);
};
```

### 7.2 더블탭 애니메이션

**CSS:**
```css
.double-tap-heart {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  opacity: 0;
  transition: opacity 0.2s ease-in;
  pointer-events: none;
}

.double-tap-heart.show {
  opacity: 1;
  animation: fadeOut 0.8s ease-out 0.2s forwards;
}

@keyframes fadeOut {
  from {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }
  to {
    opacity: 0;
    transform: translate(-50%, -50%) scale(1.2);
  }
}
```

**JavaScript:**
```typescript
const handleDoubleTap = async () => {
  if (liked) return; // 이미 좋아요한 경우 무시

  setIsDoubleTapAnimating(true);
  await addLike(postId);
  
  setTimeout(() => {
    setIsDoubleTapAnimating(false);
  }, 1000);
};
```

## 8. 에러 핸들링

### 8.1 클라이언트 에러 처리

1. **네트워크 에러**
   - 사용자에게 재시도 옵션 제공
   - Optimistic Update 롤백

2. **인증 에러 (401)**
   - 로그인 페이지로 리다이렉트
   - 또는 로그인 모달 표시

3. **서버 에러 (500)**
   - 사용자 친화적 에러 메시지 표시
   - 에러 로그 기록

4. **중복 좋아요 (409)**
   - 무시하거나 경고 메시지 표시

### 8.2 Optimistic Update 롤백

```typescript
const handleClick = async () => {
  const previousLiked = liked;
  const previousCount = likesCount;

  // Optimistic Update
  setLiked(!liked);
  setLikesCount(liked ? likesCount - 1 : likesCount + 1);

  try {
    const response = liked ? await removeLike(postId) : await addLike(postId);
    
    if (response.error) {
      // 롤백
      setLiked(previousLiked);
      setLikesCount(previousCount);
      // 에러 메시지 표시
    }
  } catch (error) {
    // 롤백
    setLiked(previousLiked);
    setLikesCount(previousCount);
  }
};
```

## 작업 순서

1. **API Route 생성** (1단계)
   - `app/api/likes/route.ts` 생성
   - POST 핸들러 구현 (좋아요 추가)
   - DELETE 핸들러 구현 (좋아요 제거)
   - 인증 및 에러 처리
   - 테스트

2. **LikeButton 컴포넌트 생성** (2단계)
   - `components/post/LikeButton.tsx` 생성
   - 기본 UI 구현 (하트 아이콘)
   - 클릭 핸들러 구현
   - 클릭 애니메이션 구현
   - API 호출 통합

3. **더블탭 기능 구현** (3단계)
   - 더블탭 감지 로직 구현
   - 큰 하트 애니메이션 구현
   - PostCard에 통합

4. **PostCard 통합** (4단계)
   - LikeButton을 PostCard에 추가
   - 좋아요 수 표시 업데이트
   - 상태 동기화

5. **PostFeed 상태 업데이트** (5단계)
   - 좋아요 변경 핸들러 구현
   - 상태 동기화

6. **스타일링 및 다듬기** (6단계)
   - Instagram 디자인에 맞게 스타일 조정
   - 애니메이션 타이밍 조정
   - 반응형 확인

## 참고 파일

- [docs/PRD.md](docs/PRD.md) - 좋아요 기능 정의 (278-283줄, 313-327줄)
- [docs/TODO.md](docs/TODO.md) - 좋아요 기능 TODO (87-99줄)
- [supabase/migrations/db.sql](supabase/migrations/db.sql) - likes 테이블 스키마 (63-86줄)
- [lib/types.ts](lib/types.ts) - TypeScript 타입 정의
- [lib/supabase/server.ts](lib/supabase/server.ts) - Supabase 서버 클라이언트
- [app/api/sync-user/route.ts](app/api/sync-user/route.ts) - API Route 예시

## 주의사항

1. **중복 좋아요 방지**: DB 제약조건 (`UNIQUE(post_id, user_id)`) 활용
2. **Optimistic Update**: 즉시 UI 업데이트 후 API 호출, 실패 시 롤백
3. **더블탭 감지**: 300ms 내 두 번 클릭 감지
4. **애니메이션 성능**: CSS transition 사용, JavaScript 애니메이션 최소화
5. **상태 동기화**: 여러 컴포넌트에서 동일한 게시물 상태 관리 시 주의
6. **에러 처리**: 사용자 친화적 에러 메시지 및 롤백 로직 필수
7. **인증**: 모든 API 호출에서 Clerk 인증 확인 필수

