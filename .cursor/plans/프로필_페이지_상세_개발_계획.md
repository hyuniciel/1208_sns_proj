# 프로필 페이지 상세 개발 계획

## 개요

Instagram 스타일의 프로필 페이지를 구현합니다. 사용자의 프로필 정보, 통계, 게시물 그리드를 표시합니다.

**참고 문서:**
- `docs/PRD.md` - 섹션 4: 프로필 페이지 디자인
- `supabase/migrations/db.sql` - 데이터베이스 스키마 (user_stats 뷰)
- 기존 컴포넌트: `PostFeed.tsx`, `PostModal.tsx`, `PostCard.tsx`

---

## 1. API Route 생성

### 1-1. `app/api/users/[userId]/route.ts` 생성

**목적:** 특정 사용자의 프로필 정보를 조회하는 API

**구현 내용:**
- `GET /api/users/[userId]`: 사용자 프로필 정보 조회
  - `userId` 파라미터로 사용자 ID 받기 (UUID 또는 Clerk ID)
  - `user_stats` 뷰를 활용하여 통계 포함
  - 사용자 기본 정보 (`users` 테이블) 조인
  - 현재 사용자가 해당 사용자를 팔로우하는지 확인 (`is_following` 필드)
  - 인증된 사용자의 경우 팔로우 상태 포함
  - 인증되지 않은 사용자도 조회 가능 (공개 프로필)

**응답 형식:**
```typescript
{
  data: {
    id: string;
    clerk_id: string;
    name: string;
    created_at: string;
    posts_count: number;
    followers_count: number;
    following_count: number;
    is_following?: boolean; // 현재 사용자가 팔로우하는지 (인증된 경우만)
    is_own_profile?: boolean; // 본인 프로필인지
  } | null,
  error: string | null
}
```

**에러 처리:**
- 404: 사용자를 찾을 수 없음
- 500: 서버 에러

**특수 케이스:**
- `userId`가 "me" 또는 현재 사용자의 Clerk ID인 경우 본인 프로필로 처리
- `userId`가 UUID인 경우 해당 사용자 조회
- `userId`가 Clerk ID인 경우도 처리 (선택적)

---

## 2. 프로필 페이지 라우트 생성

### 2-1. `app/(main)/profile/[userId]/page.tsx` 생성

**목적:** 동적 라우트로 특정 사용자의 프로필 페이지 렌더링

**구현 내용:**
- Next.js 15 동적 라우트 사용 (`params`는 Promise)
- `ProfileHeader` 컴포넌트 통합
- `PostGrid` 컴포넌트 통합
- 로딩 상태 관리
- 에러 처리

**Props 처리:**
```typescript
interface ProfilePageProps {
  params: Promise<{ userId: string }>;
}
```

**로직:**
1. `params`에서 `userId` 추출
2. `userId`가 "me"이거나 현재 사용자 ID인 경우 본인 프로필로 처리
3. API 호출하여 사용자 정보 조회
4. `PostGrid`에 `userId` 전달하여 해당 사용자의 게시물만 표시

---

### 2-2. `app/(main)/profile/page.tsx` 생성 (선택적)

**목적:** `/profile` 접근 시 본인 프로필로 리다이렉트

**구현 내용:**
- Server Component로 현재 사용자 ID 조회
- `/profile/[userId]`로 리다이렉트
- 또는 직접 `ProfileHeader`와 `PostGrid` 렌더링 (본인 프로필)

**선택지:**
1. **리다이렉트 방식 (권장)**
   - `/profile` → `/profile/[currentUserId]`로 리다이렉트
   - 코드 중복 최소화

2. **직접 렌더링 방식**
   - `/profile`에서 직접 본인 프로필 렌더링
   - URL이 깔끔함

---

## 3. ProfileHeader 컴포넌트 생성

### 3-1. 기본 구조

**파일:** `components/profile/ProfileHeader.tsx`

**Props 인터페이스:**
```typescript
interface ProfileHeaderProps {
  user: {
    id: string;
    clerk_id: string;
    name: string;
    created_at: string;
    posts_count: number;
    followers_count: number;
    following_count: number;
    is_following?: boolean;
    is_own_profile?: boolean;
  };
  currentUserId?: string; // 현재 사용자 ID (팔로우 버튼 표시용)
  onFollowChange?: (isFollowing: boolean, newFollowersCount: number) => void;
}
```

**상태 관리:**
- `isFollowing`: 팔로우 상태 (로컬 상태)
- `followersCount`: 팔로워 수 (로컬 상태)
- `isLoading`: 팔로우/언팔로우 로딩 상태

---

### 3-2. 레이아웃 구조

**Desktop 레이아웃:**
```
┌────────────────────────────────────────────┐
│ ┌────────┐                                 │
│ │        │  username                       │
│ │ 150px  │  [팔로우] [메시지]              │
│ │ 원형   │                                 │
│ │        │  게시물 12 팔로워 345 팔로잉 67  │
│ └────────┘                                 │
│            fullname (선택적)                │
│            bio (선택적, 1차 제외)           │
└────────────────────────────────────────────┘
```

**Mobile 레이아웃:**
```
┌──────────────────────────┐
│ ┌──────┐                 │
│ │ 90px │  username        │
│ │ 원형 │  [팔로우]        │
│ └──────┘                 │
│ 게시물 12 팔로워 345      │
│ 팔로잉 67                 │
└──────────────────────────┘
```

**구현 요소:**
1. **프로필 이미지**
   - Desktop: 150px 원형
   - Mobile: 90px 원형
   - 기본 아바타 (이름 첫 글자) 또는 Clerk 프로필 이미지 (나중에)

2. **사용자명**
   - Bold, 큰 글씨
   - 프로필 편집 버튼 (본인 프로필, 1차 제외)

3. **통계**
   - 게시물 수: `posts_count`
   - 팔로워 수: `followers_count` (클릭 가능, 1차 제외)
   - 팔로잉 수: `following_count` (클릭 가능, 1차 제외)
   - 숫자 포맷팅 (예: 1,234)

4. **액션 버튼**
   - 본인 프로필: "프로필 편집" 버튼 (1차 제외, Clerk 기본 사용)
   - 다른 사람 프로필: "팔로우" / "팔로잉" 버튼 (FollowButton 컴포넌트)
   - "메시지" 버튼 (1차 제외)

---

## 4. PostGrid 컴포넌트 생성

### 4-1. 기본 구조

**파일:** `components/profile/PostGrid.tsx`

**Props 인터페이스:**
```typescript
interface PostGridProps {
  userId: string;
  onPostClick?: (postId: string) => void; // 게시물 클릭 시 모달 열기
  currentUserId?: string;
}
```

**상태 관리:**
- `posts`: 게시물 목록 (썸네일만)
- `isLoading`: 로딩 상태
- `error`: 에러 메시지
- `selectedPostId`: 선택된 게시물 ID (모달용)

---

### 4-2. 그리드 레이아웃

**구현:**
- CSS Grid 사용: `grid grid-cols-3 gap-1` (또는 `gap-0.5`)
- 반응형:
  - Desktop/Tablet: 3열 고정
  - Mobile: 3열 고정 (간격 조정)
- 각 썸네일: `aspect-square` (1:1 정사각형)

**썸네일 컴포넌트:**
```typescript
interface PostThumbnailProps {
  post: {
    id: string;
    image_url: string;
    likes_count: number;
    comments_count: number;
  };
  onClick: () => void;
}
```

**Hover 효과:**
- Desktop: 마우스 오버 시 반투명 오버레이 + 좋아요/댓글 수 표시
- Mobile: 터치 시 모달 열기

**구현 예시:**
```tsx
<div className="relative group cursor-pointer" onClick={onClick}>
  <Image
    src={post.image_url}
    alt="게시물"
    fill
    className="object-cover"
    sizes="(max-width: 768px) 33vw, 210px"
  />
  {/* Hover 오버레이 */}
  <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-4 text-white">
    <span>❤️ {post.likes_count}</span>
    <span>💬 {post.comments_count}</span>
  </div>
</div>
```

---

## 5. 게시물 데이터 로딩

### 5-1. PostGrid에서 게시물 조회

**구현:**
- `useEffect`로 `userId` 변경 시 게시물 목록 조회
- `/api/posts?userId=${userId}&limit=100` 호출 (또는 무한 스크롤)
- 썸네일용 데이터만 표시 (이미지 URL, 좋아요/댓글 수)

**최적화:**
- 초기 로드: 최근 게시물 12개만
- 무한 스크롤 (선택적): 하단 도달 시 추가 로드

---

## 6. 게시물 상세 모달 통합

### 6-1. PostGrid에 PostModal 통합

**구현:**
- `PostModal` 컴포넌트 통합
- 썸네일 클릭 시 모달 열기
- `allPostIds` 배열 전달 (프로필 페이지의 모든 게시물 ID)
- 이전/다음 네비게이션 지원

**코드 예시:**
```tsx
const [selectedPostId, setSelectedPostId] = useState<string | null>(null);

const handlePostClick = (postId: string) => {
  setSelectedPostId(postId);
};

// PostModal 렌더링
<PostModal
  postId={selectedPostId}
  isOpen={!!selectedPostId}
  onClose={() => setSelectedPostId(null)}
  allPostIds={posts.map(p => p.id)}
  onNavigate={setSelectedPostId}
  currentUserId={currentUserId}
/>
```

---

## 7. 팔로우 기능 통합 (9번과 연계)

### 7-1. FollowButton 컴포넌트 (9번에서 구현 예정)

**참고:** 팔로우 기능은 9번에서 상세 구현되지만, 프로필 페이지에 통합 필요

**ProfileHeader에 통합:**
- `FollowButton` 컴포넌트 import
- 팔로우 상태 관리
- 팔로워 수 실시간 업데이트

**구현 예시:**
```tsx
<FollowButton
  targetUserId={user.id}
  initialIsFollowing={user.is_following || false}
  initialFollowersCount={user.followers_count}
  onFollowChange={(isFollowing, newCount) => {
    // 로컬 상태 업데이트
    setIsFollowing(isFollowing);
    setFollowersCount(newCount);
    // 부모 컴포넌트에 알림
    onFollowChange?.(isFollowing, newCount);
  }}
/>
```

---

## 8. Sidebar 프로필 버튼 연결

### 8-1. 현재 사용자 ID 조회

**구현:**
- Sidebar에서 현재 사용자 ID 조회
- `/profile` 또는 `/profile/[currentUserId]`로 링크

**코드 예시:**
```tsx
// Sidebar.tsx
const { user } = useUser();
const profileHref = user ? "/profile" : "/"; // 또는 "/profile/me"
```

**선택지:**
1. `/profile`로 링크 → `/profile/page.tsx`에서 리다이렉트
2. `/profile/me`로 링크 → `/profile/[userId]/page.tsx`에서 "me" 처리
3. 현재 사용자 UUID로 직접 링크 (클라이언트에서 조회 필요)

---

## 9. 반응형 디자인

### 9-1. Desktop 레이아웃

**구현:**
- 프로필 이미지: 150px
- 통계와 버튼이 한 줄에 배치
- 그리드: 3열 고정

### 9-2. Mobile 레이아웃

**구현:**
- 프로필 이미지: 90px
- 통계가 세로로 배치 (선택적)
- 그리드: 3열 유지 (간격 조정)

**CSS 클래스:**
```tsx
<div className="flex flex-col md:flex-row md:items-center gap-4 md:gap-8 px-4 py-6">
  {/* 프로필 이미지 */}
  <div className="w-[90px] h-[90px] md:w-[150px] md:h-[150px] rounded-full ...">
    {/* ... */}
  </div>
  
  {/* 정보 영역 */}
  <div className="flex-1">
    {/* ... */}
  </div>
</div>
```

---

## 10. 로딩 및 에러 상태

### 10-1. 로딩 UI

**구현:**
- `ProfileHeaderSkeleton` 컴포넌트 생성
- `PostGridSkeleton` 컴포넌트 생성 (3열 그리드 스켈레톤)

**스켈레톤 구조:**
```tsx
// ProfileHeaderSkeleton
<div className="flex flex-col md:flex-row md:items-center gap-4 md:gap-8 px-4 py-6">
  <div className="w-[90px] h-[90px] md:w-[150px] md:h-[150px] rounded-full bg-gray-200 animate-pulse" />
  <div className="flex-1 space-y-2">
    <div className="h-6 w-32 bg-gray-200 animate-pulse rounded" />
    <div className="h-4 w-24 bg-gray-200 animate-pulse rounded" />
  </div>
</div>

// PostGridSkeleton
<div className="grid grid-cols-3 gap-1">
  {Array.from({ length: 9 }).map((_, i) => (
    <div key={i} className="aspect-square bg-gray-200 animate-pulse" />
  ))}
</div>
```

### 10-2. 에러 처리

**구현:**
- 사용자를 찾을 수 없음: 404 페이지 또는 에러 메시지
- 네트워크 에러: "다시 시도" 버튼
- 권한 에러: 적절한 메시지 표시

---

## 11. 성능 최적화

### 11-1. 이미지 최적화

**구현:**
- Next.js `Image` 컴포넌트 사용
- `loading="lazy"` (그리드 썸네일)
- 적절한 `sizes` 속성

### 11-2. 데이터 페칭 최적화

**구현:**
- 프로필 정보와 게시물 목록 병렬 로딩 (선택적)
- 게시물 목록 페이지네이션 (무한 스크롤)
- React Query 또는 SWR 사용 (선택적)

---

## 12. 구현 순서

1. **API Route 생성**
   - `app/api/users/[userId]/route.ts` 생성
   - GET 핸들러 구현
   - `user_stats` 뷰 활용
   - 팔로우 상태 확인
   - 테스트

2. **프로필 페이지 라우트 생성**
   - `app/(main)/profile/[userId]/page.tsx` 생성
   - 동적 라우트 처리
   - 기본 레이아웃

3. **ProfileHeader 컴포넌트**
   - 기본 구조 생성
   - 프로필 이미지 표시
   - 사용자명 및 통계 표시
   - 반응형 레이아웃

4. **PostGrid 컴포넌트**
   - 기본 구조 생성
   - 3열 그리드 레이아웃
   - 썸네일 표시
   - Hover 효과

5. **게시물 데이터 로딩**
   - API 호출 로직
   - 로딩 상태 처리
   - 에러 처리

6. **게시물 상세 모달 통합**
   - PostModal 통합
   - 썸네일 클릭 이벤트
   - 네비게이션 지원

7. **팔로우 기능 통합** (9번과 연계)
   - FollowButton 통합
   - 상태 관리

8. **Sidebar 연결**
   - 프로필 버튼 링크 수정
   - 현재 사용자 ID 처리

9. **로딩 및 에러 UI**
   - 스켈레톤 컴포넌트 생성
   - 에러 처리 개선

10. **반응형 테스트**
    - Desktop 테스트
    - Mobile 테스트
    - 다양한 화면 크기 테스트

---

## 13. 주의사항

1. **사용자 ID 처리**
   - UUID vs Clerk ID 구분
   - "me" 키워드 처리
   - 본인 프로필 vs 다른 사람 프로필 구분

2. **팔로우 기능 의존성**
   - 팔로우 기능(9번)이 완료되기 전에는 팔로우 버튼 비활성화 또는 스켈레톤 표시
   - 또는 기본 버튼만 표시하고 나중에 통합

3. **게시물 없을 때**
   - 빈 상태 UI 표시
   - "게시물이 없습니다" 메시지

4. **프로필 편집**
   - 1차 MVP에서는 제외
   - Clerk 기본 프로필 사용
   - 나중에 확장 가능하도록 구조 설계

5. **통계 클릭 기능**
   - 팔로워/팔로잉 목록 모달은 1차 제외
   - 나중에 확장 가능하도록 구조 설계

---

## 14. 참고 파일

- `components/post/PostFeed.tsx` - 게시물 목록 로딩 참고
- `components/post/PostModal.tsx` - 모달 통합 참고
- `components/post/PostCard.tsx` - 게시물 데이터 구조 참고
- `app/api/posts/route.ts` - 게시물 API 참고 (userId 파라미터)
- `app/api/users/me/route.ts` - 현재 사용자 API 참고
- `components/layout/Sidebar.tsx` - 프로필 링크 참고

---

## 완료 체크리스트

- [ ] `app/api/users/[userId]/route.ts` 생성 및 구현
- [ ] `app/(main)/profile/[userId]/page.tsx` 생성
- [ ] `app/(main)/profile/page.tsx` 생성 (선택적, 리다이렉트용)
- [ ] `components/profile/ProfileHeader.tsx` 기본 구조 생성
- [ ] 프로필 이미지 표시 (기본 아바타)
- [ ] 사용자명 및 통계 표시
- [ ] 반응형 레이아웃 (Desktop/Mobile)
- [ ] `components/profile/PostGrid.tsx` 기본 구조 생성
- [ ] 3열 그리드 레이아웃 구현
- [ ] 썸네일 표시 및 Hover 효과
- [ ] 게시물 데이터 로딩 로직
- [ ] PostModal 통합
- [ ] FollowButton 통합 (9번과 연계)
- [ ] Sidebar 프로필 버튼 연결
- [ ] 로딩 UI (스켈레톤)
- [ ] 에러 처리
- [ ] 빈 상태 UI
- [ ] 반응형 테스트

