# 게시물 작성 기능 개발 계획

## 개요

Instagram 스타일의 게시물 작성 기능을 구현합니다. 사용자가 이미지를 업로드하고 캡션을 입력하여 게시물을 생성할 수 있습니다.

## 1. CreatePostModal 컴포넌트

### 1.1 `components/post/CreatePostModal.tsx` 생성

**기능:**
- Dialog 컴포넌트 사용 (shadcn/ui)
- 이미지 미리보기 UI
- 텍스트 입력 필드 (최대 2,200자)
- 파일 선택 버튼
- 업로드 버튼
- 로딩 상태 관리
- 에러 처리

**구성 요소:**

1. **Dialog 구조**
   - 열림/닫힘 상태 관리
   - 모달 헤더: "새 게시물 만들기"
   - 모달 본문: 이미지 미리보기 + 입력 영역
   - 모달 푸터: 취소 버튼 + 공유 버튼

2. **이미지 선택 및 미리보기**
   - 파일 입력 (hidden input)
   - 드래그 앤 드롭 지원 (선택적)
   - 이미지 미리보기 (1:1 정사각형 비율 유지)
   - 이미지 교체 버튼
   - 이미지 제거 버튼

3. **캡션 입력 필드**
   - Textarea 컴포넌트 사용
   - Placeholder: "문구 입력..."
   - 최대 2,200자 제한
   - 글자 수 표시 (예: "1,234 / 2,200")
   - 자동 높이 조절 (선택적)

4. **업로드 버튼**
   - 이미지가 선택되지 않으면 비활성화
   - 업로드 중 로딩 상태 표시
   - 성공 시 모달 닫기 및 피드 새로고침

**Props 타입:**
```typescript
interface CreatePostModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onSuccess?: () => void; // 업로드 성공 시 콜백
}
```

**상태 관리:**
- `selectedFile`: 선택된 이미지 파일
- `previewUrl`: 미리보기 이미지 URL (Object URL)
- `caption`: 캡션 텍스트
- `isUploading`: 업로드 중 상태
- `error`: 에러 메시지

**구현 세부사항:**

1. **파일 선택**
   ```typescript
   const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {
     const file = event.target.files?.[0];
     if (!file) return;

     // 파일 검증 (크기, 타입)
     // 미리보기 URL 생성
     // 상태 업데이트
   };
   ```

2. **이미지 미리보기**
   - `URL.createObjectURL()` 사용
   - 컴포넌트 언마운트 시 `URL.revokeObjectURL()` 호출
   - 1:1 비율 유지 (CSS `aspect-ratio`)

3. **캡션 입력**
   - `maxLength={2200}` 속성으로 제한
   - 실시간 글자 수 표시
   - 줄바꿈 허용

4. **업로드 처리**
   - FormData 생성
   - `/api/posts` POST 요청
   - 성공 시 모달 닫기 및 콜백 호출

**코드 구조:**
```typescript
'use client';

import { useState, useRef, useEffect } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Upload, X, Loader2 } from 'lucide-react';

interface CreatePostModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onSuccess?: () => void;
}

export default function CreatePostModal({
  open,
  onOpenChange,
  onSuccess,
}: CreatePostModalProps) {
  const [selectedFile, setSelectedFile] = useState<File | null>(null);
  const [previewUrl, setPreviewUrl] = useState<string | null>(null);
  const [caption, setCaption] = useState('');
  const [isUploading, setIsUploading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  // 미리보기 URL 정리
  useEffect(() => {
    return () => {
      if (previewUrl) {
        URL.revokeObjectURL(previewUrl);
      }
    };
  }, [previewUrl]);

  // 모달 닫힐 때 상태 초기화
  useEffect(() => {
    if (!open) {
      setSelectedFile(null);
      setPreviewUrl(null);
      setCaption('');
      setError(null);
    }
  }, [open]);

  const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {
    // 파일 선택 처리
  };

  const handleRemoveImage = () => {
    // 이미지 제거 처리
  };

  const handleUpload = async () => {
    // 업로드 처리
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>새 게시물 만들기</DialogTitle>
        </DialogHeader>

        <div className="space-y-4">
          {/* 이미지 미리보기 영역 */}
          {/* 캡션 입력 영역 */}
          {/* 에러 메시지 */}
          {/* 버튼 영역 */}
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

**스타일링:**
- 모달 너비: `max-w-2xl` (Desktop)
- 이미지 미리보기: 1:1 비율, 최대 높이 400px
- 캡션 입력: 전체 너비, 최소 높이 120px
- 버튼: 우측 정렬, 간격 8px

## 2. API Route: 게시물 생성

### 2.1 `app/api/posts/route.ts` 업데이트

**기능:**
- POST: 게시물 생성
- 이미지 파일 검증 (최대 5MB, 이미지 타입만)
- Supabase Storage 업로드
- posts 테이블에 데이터 저장
- 인증 검증 (Clerk)

**구현 세부사항:**

#### POST 핸들러

1. **인증 확인**
   - Clerk `auth()`로 현재 사용자 확인
   - 인증되지 않은 경우 401 반환

2. **FormData 파싱**
   - `image`: 이미지 파일 (File)
   - `caption`: 캡션 텍스트 (선택적, 최대 2,200자)

3. **파일 검증**
   - 파일 존재 확인
   - 파일 크기 확인 (최대 5MB = 5 * 1024 * 1024 bytes)
   - 파일 타입 확인 (image/jpeg, image/png, image/webp, image/gif)
   - MIME 타입 검증

4. **사용자 ID 조회**
   - Clerk `userId`로 Supabase `users` 테이블에서 사용자 UUID 조회
   - 사용자가 존재하지 않으면 404 반환

5. **Supabase Storage 업로드**
   - 파일명 생성: `{timestamp}-{random}.{ext}`
   - 경로: `{clerk_user_id}/{filename}`
   - 버킷: `posts` (공개 버킷)
   - 업로드 옵션:
     - `cacheControl: "3600"` (1시간 캐시)
     - `upsert: false` (중복 방지)

6. **Public URL 가져오기**
   - Storage에서 업로드된 파일의 공개 URL 가져오기
   - 형식: `https://{project}.supabase.co/storage/v1/object/public/posts/{path}`

7. **캡션 검증**
   - 최대 2,200자 제한
   - 빈 문자열은 `null`로 저장

8. **posts 테이블에 저장**
   - `user_id`: 사용자 UUID
   - `image_url`: Storage 공개 URL
   - `caption`: 캡션 (null 가능)
   - `created_at`, `updated_at`: 자동 설정

9. **응답 반환**
   ```typescript
   {
     success: true,
     post: {
       id: string,
       user_id: string,
       image_url: string,
       caption: string | null,
       created_at: string,
       updated_at: string
     }
   }
   ```

**코드 구조:**
```typescript
import { NextRequest, NextResponse } from "next/server";
import { auth } from "@clerk/nextjs/server";
import { createClerkSupabaseClient } from "@/lib/supabase/server";
import type { Post } from "@/lib/types";

const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
const ALLOWED_MIME_TYPES = [
  'image/jpeg',
  'image/png',
  'image/webp',
  'image/gif',
];
const MAX_CAPTION_LENGTH = 2200;

export async function POST(request: NextRequest) {
  try {
    // 1. 인증 확인
    const { userId: clerkUserId } = await auth();
    if (!clerkUserId) {
      return NextResponse.json(
        { error: "Unauthorized" },
        { status: 401 }
      );
    }

    // 2. FormData 파싱
    const formData = await request.formData();
    const image = formData.get('image') as File;
    const caption = formData.get('caption') as string | null;

    // 3. 파일 검증
    if (!image) {
      return NextResponse.json(
        { error: "Image is required" },
        { status: 400 }
      );
    }

    if (image.size > MAX_FILE_SIZE) {
      return NextResponse.json(
        { error: `File size exceeds ${MAX_FILE_SIZE / 1024 / 1024}MB limit` },
        { status: 400 }
      );
    }

    if (!ALLOWED_MIME_TYPES.includes(image.type)) {
      return NextResponse.json(
        { error: "Invalid file type. Only JPEG, PNG, WebP, and GIF are allowed" },
        { status: 400 }
      );
    }

    // 4. 사용자 ID 조회
    const supabase = createClerkSupabaseClient();
    const { data: user, error: userError } = await supabase
      .from("users")
      .select("id")
      .eq("clerk_id", clerkUserId)
      .single();

    if (userError || !user) {
      return NextResponse.json(
        { error: "User not found" },
        { status: 404 }
      );
    }

    // 5. Supabase Storage 업로드
    const fileExt = image.name.split('.').pop();
    const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;
    const filePath = `${clerkUserId}/${fileName}`;

    const { data: uploadData, error: uploadError } = await supabase.storage
      .from('posts')
      .upload(filePath, image, {
        cacheControl: '3600',
        upsert: false,
      });

    if (uploadError) {
      console.error('Storage upload error:', uploadError);
      return NextResponse.json(
        { error: "Failed to upload image", details: uploadError.message },
        { status: 500 }
      );
    }

    // 6. Public URL 가져오기
    const { data: urlData } = supabase.storage
      .from('posts')
      .getPublicUrl(filePath);

    const imageUrl = urlData.publicUrl;

    // 7. 캡션 검증
    const validatedCaption = caption && caption.trim().length > 0
      ? caption.trim().substring(0, MAX_CAPTION_LENGTH)
      : null;

    // 8. posts 테이블에 저장
    const { data: post, error: insertError } = await supabase
      .from('posts')
      .insert({
        user_id: user.id,
        image_url: imageUrl,
        caption: validatedCaption,
      })
      .select()
      .single();

    if (insertError) {
      console.error('Database insert error:', insertError);
      // 업로드된 파일 삭제 시도 (선택적)
      await supabase.storage.from('posts').remove([filePath]);
      
      return NextResponse.json(
        { error: "Failed to create post", details: insertError.message },
        { status: 500 }
      );
    }

    // 9. 응답 반환
    return NextResponse.json({
      success: true,
      post,
    }, { status: 201 });

  } catch (error) {
    console.error('Create post error:', error);
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}
```

**에러 처리:**
- 인증 실패: 401 Unauthorized
- 파일 없음: 400 Bad Request
- 파일 크기 초과: 400 Bad Request
- 잘못된 파일 타입: 400 Bad Request
- 사용자 없음: 404 Not Found
- Storage 업로드 실패: 500 Internal Server Error
- DB 저장 실패: 500 Internal Server Error (업로드된 파일 삭제 시도)

**유틸리티 함수:**
```typescript
// Clerk userId로 Supabase user_id 조회
async function getSupabaseUserId(clerkUserId: string): Promise<string | null> {
  const supabase = createClerkSupabaseClient();
  const { data, error } = await supabase
    .from("users")
    .select("id")
    .eq("clerk_id", clerkUserId)
    .single();
  
  if (error || !data) return null;
  return data.id;
}
```

## 3. Sidebar "만들기" 버튼 연결

### 3.1 `components/layout/Sidebar.tsx` 업데이트

**변경 사항:**

1. **CreatePostModal 상태 관리**
   - `useState`로 모달 열림 상태 관리
   - `open`과 `onOpenChange` props 전달

2. **"만들기" 버튼 클릭 핸들러**
   - 기존 `console.log` 제거
   - 모달 열기 함수로 변경

3. **CreatePostModal 통합**
   - `CreatePostModal` 컴포넌트 import
   - Sidebar에 렌더링
   - `onSuccess` 콜백으로 피드 새로고침 (선택적)

**코드 구조:**
```typescript
'use client';

import { useState } from 'react';
import CreatePostModal from '@/components/post/CreatePostModal';

export default function Sidebar() {
  const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);

  const handleCreateClick = () => {
    setIsCreateModalOpen(true);
  };

  const handleCreateSuccess = () => {
    // 피드 새로고침 (선택적)
    // 또는 PostFeed에 ref를 전달하여 새로고침
  };

  return (
    <>
      {/* 기존 Sidebar 코드 */}
      <button onClick={handleCreateClick}>
        {/* 만들기 버튼 */}
      </button>

      <CreatePostModal
        open={isCreateModalOpen}
        onOpenChange={setIsCreateModalOpen}
        onSuccess={handleCreateSuccess}
      />
    </>
  );
}
```

### 3.2 `components/layout/BottomNav.tsx` 업데이트

**변경 사항:**
- Sidebar와 동일하게 CreatePostModal 통합
- "만들기" 버튼 클릭 시 모달 열기

## 4. PostFeed 새로고침

### 4.1 `components/post/PostFeed.tsx` 업데이트

**변경 사항:**

1. **새로고침 함수**
   - `loadPosts(0)` 함수를 외부에서 호출 가능하도록 설정
   - `useImperativeHandle` 또는 콜백 prop 사용

2. **CreatePostModal 콜백**
   - 게시물 생성 성공 시 피드 새로고침
   - 또는 새 게시물을 배열 맨 앞에 추가

**방법 1: 콜백 prop 사용**
```typescript
// PostFeed.tsx
interface PostFeedProps {
  onPostCreated?: () => void; // 외부에서 새로고침 함수 전달
}

export default function PostFeed({ onPostCreated }: PostFeedProps) {
  const refresh = () => {
    setOffset(0);
    loadPosts(0);
  };

  useEffect(() => {
    if (onPostCreated) {
      // 외부에서 새로고침 함수를 받아서 사용
    }
  }, [onPostCreated]);

  // ...
}
```

**방법 2: Context 사용 (선택적)**
```typescript
// contexts/PostFeedContext.tsx
const PostFeedContext = createContext<{
  refresh: () => void;
} | null>(null);

// CreatePostModal에서 사용
const { refresh } = usePostFeed();
// 업로드 성공 시 refresh() 호출
```

**방법 3: 간단한 방법 (권장)**
```typescript
// CreatePostModal에서 window.location.reload() 또는
// 부모 컴포넌트에서 상태로 관리
```

## 5. 파일 검증 유틸리티

### 5.1 `lib/utils/validation.ts` 생성 (선택적)

**기능:**
- 이미지 파일 검증 함수
- 파일 크기, 타입 검증

**구현:**
```typescript
export interface FileValidationResult {
  valid: boolean;
  error?: string;
}

export function validateImageFile(file: File): FileValidationResult {
  const MAX_SIZE = 5 * 1024 * 1024; // 5MB
  const ALLOWED_TYPES = [
    'image/jpeg',
    'image/png',
    'image/webp',
    'image/gif',
  ];

  if (!file) {
    return { valid: false, error: '파일을 선택해주세요.' };
  }

  if (file.size > MAX_SIZE) {
    return { valid: false, error: '파일 크기는 5MB를 초과할 수 없습니다.' };
  }

  if (!ALLOWED_TYPES.includes(file.type)) {
    return {
      valid: false,
      error: '지원되는 이미지 형식: JPEG, PNG, WebP, GIF',
    };
  }

  return { valid: true };
}
```

## 6. 이미지 최적화 (선택적)

### 6.1 클라이언트 사이드 이미지 압축

**라이브러리:**
- `browser-image-compression` 사용 (선택적)

**구현:**
```typescript
import imageCompression from 'browser-image-compression';

const compressImage = async (file: File): Promise<File> => {
  const options = {
    maxSizeMB: 1, // 최대 1MB로 압축
    maxWidthOrHeight: 1920, // 최대 너비/높이
    useWebWorker: true,
  };

  return await imageCompression(file, options);
};
```

**사용:**
- CreatePostModal에서 업로드 전 이미지 압축
- 파일 크기 감소로 업로드 속도 향상

## 7. 드래그 앤 드롭 (선택적)

### 7.1 CreatePostModal에 드래그 앤 드롭 추가

**기능:**
- 이미지 영역에 파일 드래그 앤 드롭 지원
- 드래그 오버 시 시각적 피드백

**구현:**
```typescript
const [isDragging, setIsDragging] = useState(false);

const handleDragOver = (e: React.DragEvent) => {
  e.preventDefault();
  setIsDragging(true);
};

const handleDragLeave = () => {
  setIsDragging(false);
};

const handleDrop = (e: React.DragEvent) => {
  e.preventDefault();
  setIsDragging(false);
  
  const file = e.dataTransfer.files[0];
  if (file && file.type.startsWith('image/')) {
    handleFileSelect({ target: { files: [file] } } as any);
  }
};
```

## 8. 에러 핸들링

### 8.1 클라이언트 에러 처리

1. **파일 검증 에러**
   - 파일 크기 초과: "파일 크기는 5MB를 초과할 수 없습니다."
   - 잘못된 파일 타입: "지원되는 이미지 형식: JPEG, PNG, WebP, GIF"
   - 파일 없음: "이미지를 선택해주세요."

2. **네트워크 에러**
   - 업로드 실패: "이미지 업로드에 실패했습니다. 다시 시도해주세요."
   - 재시도 버튼 제공

3. **인증 에러 (401)**
   - 로그인 페이지로 리다이렉트
   - 또는 로그인 모달 표시

4. **서버 에러 (500)**
   - 사용자 친화적 에러 메시지 표시
   - 에러 로그 기록

### 8.2 서버 에러 처리

1. **Storage 업로드 실패**
   - 에러 로그 기록
   - 사용자에게 명확한 에러 메시지 반환

2. **DB 저장 실패**
   - 업로드된 파일 삭제 시도 (롤백)
   - 에러 로그 기록
   - 사용자에게 에러 메시지 반환

## 작업 순서

1. **CreatePostModal 컴포넌트 생성** (1단계)
   - Dialog 구조 구현
   - 파일 선택 및 미리보기 구현
   - 캡션 입력 필드 구현
   - 기본 UI 완성

2. **API Route 생성** (2단계)
   - `app/api/posts/route.ts` POST 핸들러 구현
   - 파일 검증 로직 구현
   - Supabase Storage 업로드 구현
   - DB 저장 구현
   - 에러 처리

3. **CreatePostModal 업로드 기능 통합** (3단계)
   - API 호출 로직 구현
   - 로딩 상태 관리
   - 에러 처리 및 표시
   - 성공 시 모달 닫기

4. **Sidebar 통합** (4단계)
   - CreatePostModal 상태 관리
   - "만들기" 버튼 클릭 핸들러 연결
   - 모달 렌더링

5. **PostFeed 새로고침** (5단계)
   - 게시물 생성 성공 시 피드 새로고침
   - 또는 새 게시물을 배열 맨 앞에 추가

6. **스타일링 및 다듬기** (6단계)
   - Instagram 디자인에 맞게 스타일 조정
   - 반응형 확인
   - 애니메이션 추가 (선택적)

7. **추가 기능** (7단계, 선택적)
   - 드래그 앤 드롭
   - 이미지 압축
   - 이미지 편집 (크롭, 필터 등)

## 참고 파일

- [docs/PRD.md](docs/PRD.md) - 게시물 작성 기능 정의 (267-276줄, 448-460줄)
- [docs/TODO.md](docs/TODO.md) - 게시물 작성 TODO (101-116줄)
- [supabase/migrations/db.sql](supabase/migrations/db.sql) - posts 테이블 스키마 (34-58줄)
- [supabase/migrations/20251208142033_setup_storage.sql](supabase/migrations/20251208142033_setup_storage.sql) - Storage 버킷 설정
- [lib/types.ts](lib/types.ts) - TypeScript 타입 정의
- [lib/supabase/server.ts](lib/supabase/server.ts) - Supabase 서버 클라이언트
- [app/storage-test/page.tsx](app/storage-test/page.tsx) - Storage 업로드 예시

## 주의사항

1. **파일 검증**: 클라이언트와 서버 양쪽에서 검증 필수
2. **파일 크기**: 5MB 제한 (PRD 기준)
3. **캡션 길이**: 최대 2,200자 제한
4. **이미지 비율**: 미리보기에서 1:1 비율 유지
5. **에러 처리**: 사용자 친화적 에러 메시지 및 롤백 로직 필수
6. **인증**: 모든 API 호출에서 Clerk 인증 확인 필수
7. **Storage 경로**: `{clerk_user_id}/{filename}` 형식 사용
8. **Public URL**: 공개 버킷이므로 Public URL 사용
9. **메모리 관리**: Object URL 사용 후 `revokeObjectURL()` 호출 필수
10. **중복 업로드 방지**: `upsert: false` 옵션 사용

